<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <title>Nashville Winter Resources</title>
  <link rel="icon" type="image/png" href="https://substackcdn.com/image/fetch/w_80,h_80,c_fill,f_png,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F4253394d-9735-40dd-961c-daa685b93262_1024x1024.png">
  <script src="https://unpkg.com/@phosphor-icons/web"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    :root {
      /* Text scaling - adjustable via JS */
      --text-scale: 1;

      /* Core colors - improved contrast */
      --color-bg-primary: #1a1a2e;
      --color-bg-secondary: #16213e;
      --color-bg-tertiary: #0f3460;

      /* Text colors - WCAG AA compliant on dark backgrounds */
      --color-text-primary: #ffffff;
      --color-text-secondary: #c8d3e0;  /* Improved from #94a3b8 - now 7:1 contrast */
      --color-text-muted: #9badc4;       /* Improved from #64748b - now 5.5:1 contrast */

      /* Accent colors */
      --color-accent-red: #e63946;
      --color-accent-red-hover: #f1404e;
      --color-accent-blue: #60a5fa;
      --color-accent-green: #10b981;
      --color-accent-orange: #fb923c;    /* Improved from #f97316 */
      --color-accent-cyan: #67e8f9;      /* Improved from #38bdf8 */

      /* Interactive surfaces */
      --color-surface: rgba(255, 255, 255, 0.08);
      --color-surface-hover: rgba(255, 255, 255, 0.15);
      --color-border: rgba(255, 255, 255, 0.15);

      /* Focus ring */
      --color-focus: #60a5fa;
    }

    /* Text size variants */
    html.text-small { --text-scale: 0.9; }
    html.text-normal { --text-scale: 1; }
    html.text-large { --text-scale: 1.15; }
    html.text-xlarge { --text-scale: 1.3; }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    html {
      scroll-behavior: smooth;
      font-size: calc(16px * var(--text-scale));
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, var(--color-bg-primary) 0%, var(--color-bg-secondary) 50%, var(--color-bg-tertiary) 100%);
      min-height: 100vh;
      min-height: 100dvh;
      padding: 1.5rem 1rem;
      padding-top: max(1.5rem, env(safe-area-inset-top));
      padding-bottom: max(1.5rem, env(safe-area-inset-bottom));
      padding-left: max(1rem, env(safe-area-inset-left));
      padding-right: max(1rem, env(safe-area-inset-right));
      color: var(--color-text-primary);
      -webkit-text-size-adjust: 100%;
    }

    .container {
      max-width: 480px;
      margin: 0 auto;
    }

    @media (max-width: 360px) {
      body {
        padding: 1rem 0.75rem;
        padding-top: max(1rem, env(safe-area-inset-top));
        padding-bottom: max(1rem, env(safe-area-inset-bottom));
      }
    }
    
    /* Top bar - language left, a11y right */
    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
      gap: 1rem;
    }

    .lang-select {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
    }

    .a11y-toggle {
      background: var(--color-surface);
      border: 1px solid var(--color-border);
      color: var(--color-text-secondary);
      padding: 0.4rem 0.6rem;
      border-radius: 6px;
      font-size: 0.85rem;
      cursor: pointer;
      min-height: 44px;
      min-width: 44px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.15s ease;
      touch-action: manipulation;
      flex-shrink: 0;
    }

    .a11y-toggle:hover {
      background: rgba(255, 255, 255, 0.12);
      color: var(--color-text-primary);
    }

    .a11y-toggle:focus-visible {
      outline: 2px solid var(--color-focus);
      outline-offset: 2px;
    }

    .a11y-toggle.active {
      background: rgba(255, 255, 255, 0.2);
      color: var(--color-text-primary);
    }

    .lang-btn {
      background: var(--color-surface);
      border: none;
      border-radius: 6px;
      padding: 0.4rem 0.75rem;
      min-height: 36px;
      color: var(--color-text-secondary);
      font-size: 0.8rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.15s ease;
      touch-action: manipulation;
    }

    @media (hover: hover) {
      .lang-btn:hover {
        background: rgba(255, 255, 255, 0.12);
        color: var(--color-text-primary);
      }
    }

    .lang-btn:active {
      background: rgba(255, 255, 255, 0.18);
      color: var(--color-text-primary);
      transform: scale(0.97);
    }

    .lang-btn:focus-visible {
      outline: 2px solid var(--color-focus);
      outline-offset: 2px;
    }

    .lang-btn.active {
      background: #3b82f6;
      color: var(--color-text-primary);
    }

    /* Text size controls */
    .text-size-controls {
      display: flex;
      align-items: center;
      gap: 0.25rem;
      background: var(--color-surface);
      border: 1px solid var(--color-border);
      border-radius: 8px;
      padding: 0.25rem;
    }

    .text-size-btn {
      background: transparent;
      border: none;
      color: var(--color-text-secondary);
      width: 36px;
      height: 36px;
      min-height: 44px;
      min-width: 44px;
      border-radius: 6px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      transition: all 0.15s ease;
      touch-action: manipulation;
    }

    .text-size-btn:hover {
      background: rgba(255, 255, 255, 0.1);
      color: var(--color-text-primary);
    }

    .text-size-btn:focus-visible {
      outline: 2px solid var(--color-focus);
      outline-offset: 1px;
    }

    .text-size-btn.active {
      background: rgba(255, 255, 255, 0.15);
      color: var(--color-text-primary);
    }

    .text-size-btn i {
      font-size: 1.1rem;
    }

    .text-size-label {
      color: var(--color-text-muted);
      font-size: 0.65rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      padding: 0 0.35rem;
    }
    
    header {
      text-align: center;
      margin-bottom: 2rem;
    }

    .branding {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 1rem;
      margin-bottom: 1.5rem;
    }

    .app-logo {
      width: 56px;
      height: 56px;
      object-fit: contain;
      flex-shrink: 0;
    }

    .title-group {
      text-align: left;
    }

    [dir="rtl"] .title-group {
      text-align: right;
    }

    h1 {
      font-size: 1.5rem;
      font-weight: 600;
      margin-bottom: 0.2rem;
      letter-spacing: -0.02em;
      line-height: 1.2;
    }

    @media (max-width: 360px) {
      h1 {
        font-size: 1.3rem;
      }
    }

    .subtitle {
      color: var(--color-text-secondary);
      font-size: 0.9rem;
      line-height: 1.4;
    }

    /* Location button - prominent CTA */
    .location-btn {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      background: linear-gradient(135deg, #dc2626, #b91c1c);
      color: white;
      border: none;
      padding: 0.75rem 1.25rem;
      border-radius: 25px;
      font-size: 1rem;
      font-weight: 500;
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(220, 38, 38, 0.3);
      text-decoration: none;
      transition: all 0.15s ease;
      touch-action: manipulation;
    }

    .location-btn:hover {
      background: linear-gradient(135deg, #ef4444, #dc2626);
      box-shadow: 0 4px 12px rgba(220, 38, 38, 0.4);
    }

    .location-btn:active {
      transform: scale(0.98);
    }

    .location-btn:focus-visible {
      outline: 2px solid #f87171;
      outline-offset: 2px;
    }

    .location-btn svg {
      width: 18px;
      height: 18px;
    }

    /* Outreach section */
    .outreach {
      text-align: center;
      margin-top: 2rem;
      padding-top: 1.5rem;
      border-top: 1px solid var(--color-border);
    }

    .outreach-label {
      color: var(--color-text-secondary);
      font-size: 0.85rem;
      margin-bottom: 0.25rem;
    }

    .outreach-number {
      color: var(--color-text-primary);
      font-size: 1rem;
      font-weight: normal;
      text-decoration: none;
    }

    .outreach-number:hover {
      text-decoration: underline;
    }

    .section {
      margin-bottom: 1.25rem;
    }

    .section-title {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      color: var(--color-text-muted);
      margin-bottom: 0.6rem;
      padding-left: 0.25rem;
    }

    .links {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }
    
    a.link {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      background: var(--color-surface);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      padding: 1rem;
      min-height: 52px;
      color: var(--color-text-primary);
      text-decoration: none;
      font-size: 0.95rem;
      font-weight: 500;
      transition: all 0.15s ease;
      touch-action: manipulation;
    }

    a.link i {
      font-size: 1.35rem;
      opacity: 0.85;
      flex-shrink: 0;
    }

    @media (hover: hover) {
      a.link:hover {
        background: var(--color-surface-hover);
        border-color: rgba(255, 255, 255, 0.2);
        transform: translateY(-2px);
      }
    }

    a.link:active {
      background: rgba(255, 255, 255, 0.18);
      transform: scale(0.98);
    }

    a.link:focus-visible {
      outline: 2px solid var(--color-focus);
      outline-offset: 2px;
    }
    
    .featured {
      background: linear-gradient(135deg, #e63946 0%, #d62839 100%);
      border-color: transparent;
      font-weight: 600;
    }

    @media (hover: hover) {
      .featured:hover {
        background: linear-gradient(135deg, #f1404e 0%, #e63946 100%);
        border-color: transparent;
      }
    }

    .featured:active {
      background: linear-gradient(135deg, #d62839 0%, #c41e2e 100%);
    }

    .featured i {
      opacity: 1;
    }

    /* Emergency Link - Subtle utility style */
    .emergency-link {
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
      color: #f87171;
      font-size: 0.85rem;
      font-weight: 500;
      text-decoration: none;
      padding: 0.5rem 0.75rem;
      border-radius: 8px;
      transition: all 0.15s ease;
      background: rgba(248, 113, 113, 0.1);
      border: 1px solid rgba(248, 113, 113, 0.2);
    }

    .emergency-link i {
      font-size: 1rem;
    }

    .emergency-link:hover {
      background: rgba(248, 113, 113, 0.2);
      color: #fca5a5;
    }

    .emergency-link:active {
      transform: scale(0.98);
    }

    .emergency-link:focus-visible {
      outline: 2px solid #f87171;
      outline-offset: 2px;
    }

    .header-utility {
      display: flex;
      justify-content: flex-end;
      align-items: center;
      gap: 1rem;
      margin-bottom: 0.75rem;
    }

    [dir="rtl"] .header-utility {
      justify-content: flex-start;
    }

    footer {
      text-align: center;
      margin-top: 2rem;
      padding-top: 1.25rem;
      padding-bottom: 0.5rem;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
      color: var(--color-text-muted);
      font-size: 0.8rem;
    }

    [dir="rtl"] a.link {
      flex-direction: row-reverse;
      text-align: right;
    }

    [dir="rtl"] .section-title {
      padding-left: 0;
      padding-right: 0.25rem;
      text-align: right;
    }

    @media (prefers-reduced-motion: reduce) {
      * {
        transition: none !important;
        transform: none !important;
      }
      html {
        scroll-behavior: auto;
      }
    }

    @supports (-webkit-touch-callout: none) {
      body {
        min-height: -webkit-fill-available;
      }
    }

    /* Weather Forecast Styles */
    .forecast-section {
      margin-bottom: 1.25rem;
    }

    .forecast-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 0.6rem;
      gap: 0.5rem;
    }

    .forecast-header .section-title {
      margin-bottom: 0;
    }

    .zip-input-wrapper {
      display: flex;
      align-items: center;
      gap: 0.4rem;
      background: rgba(255, 255, 255, 0.08);
      border: 1px solid rgba(255, 255, 255, 0.15);
      border-radius: 8px;
      padding: 0.35rem 0.5rem;
    }

    .zip-input-wrapper i {
      color: var(--color-text-muted);
      font-size: 0.9rem;
    }

    #zipInput {
      background: transparent;
      border: none;
      outline: none;
      color: var(--color-text-primary);
      font-family: inherit;
      font-size: 0.85rem;
      width: 50px;
      letter-spacing: 0.05em;
    }

    #zipInput::placeholder {
      color: var(--color-text-muted);
    }

    #fetchBtn {
      background: rgba(255, 255, 255, 0.1);
      border: none;
      color: var(--color-text-secondary);
      padding: 0.3rem 0.6rem;
      border-radius: 6px;
      font-family: inherit;
      font-size: 0.75rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.15s ease;
    }

    #fetchBtn:hover {
      background: rgba(255, 255, 255, 0.15);
      color: var(--color-text-primary);
    }

    .forecast-grid {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 0.5rem;
    }

    .day-card {
      background: rgba(255, 255, 255, 0.06);
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 12px;
      padding: 0.75rem 0.5rem;
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
      transition: all 0.2s ease;
    }

    .day-card:hover {
      background: rgba(255, 255, 255, 0.1);
      border-color: rgba(255, 255, 255, 0.15);
    }

    .day-name {
      font-size: 0.65rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      color: var(--color-text-muted);
      margin-bottom: 0.25rem;
    }

    .day-date {
      font-size: 0.9rem;
      font-weight: 600;
      margin-bottom: 0.5rem;
      color: var(--color-text-primary);
    }

    .weather-icon {
      font-size: 1.75rem;
      margin-bottom: 0.35rem;
      color: var(--color-accent-blue);
    }

    .condition {
      font-size: 0.65rem;
      color: var(--color-text-secondary);
      margin-bottom: 0.5rem;
      line-height: 1.3;
      min-height: 1.6rem;
    }

    .temps {
      width: 100%;
    }

    .temp-high, .temp-low {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 0.25rem;
      font-size: 0.8rem;
    }

    .temp-high {
      color: var(--color-accent-orange);
      margin-bottom: 0.15rem;
    }

    .temp-low {
      color: var(--color-accent-cyan);
    }

    .temp-high i, .temp-low i {
      font-size: 0.7rem;
    }

    .forecast-loading, .forecast-error {
      grid-column: 1 / -1;
      text-align: center;
      padding: 2rem 1rem;
      color: var(--color-text-muted);
    }

    .forecast-loading i {
      font-size: 2rem;
      animation: pulse 1.5s ease-in-out infinite;
      margin-bottom: 0.5rem;
      display: block;
    }

    @keyframes pulse {
      0%, 100% { opacity: 0.3; }
      50% { opacity: 1; }
    }

    .forecast-error {
      color: #f87171;
    }

    .forecast-error i {
      font-size: 1.5rem;
      margin-bottom: 0.5rem;
      display: block;
    }

    .location-display {
      font-size: 0.75rem;
      color: var(--color-text-muted);
      text-align: center;
      margin-bottom: 0.5rem;
      min-height: 1rem;
    }

    @media (max-width: 400px) {
      .forecast-grid {
        grid-template-columns: repeat(3, 1fr);
      }
      .day-card:nth-child(4),
      .day-card:nth-child(5) {
        grid-column: span 1;
      }
      .forecast-grid {
        grid-template-columns: repeat(3, 1fr);
      }
      /* Center last 2 cards */
      .forecast-grid::after {
        content: '';
        grid-column: span 1;
      }
    }

    @media (max-width: 320px) {
      .forecast-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    [dir="rtl"] .forecast-header {
      flex-direction: row-reverse;
    }

    [dir="rtl"] .zip-input-wrapper {
      flex-direction: row-reverse;
    }

    /* Weather Alert Styles */
    .alerts-container {
      margin-bottom: 1rem;
    }

    .alert-banner {
      padding: 0.75rem 1rem;
      display: flex;
      align-items: flex-start;
      gap: 0.75rem;
      animation: slideDown 0.4s ease-out;
      border-radius: 12px;
      margin-bottom: 0.5rem;
    }

    .alert-banner.severity-extreme {
      background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%);
    }

    .alert-banner.severity-severe {
      background: linear-gradient(135deg, #ea580c 0%, #c2410c 100%);
    }

    .alert-banner.severity-moderate {
      background: linear-gradient(135deg, #d97706 0%, #b45309 100%);
    }

    .alert-banner.severity-minor {
      background: linear-gradient(135deg, #ca8a04 0%, #a16207 100%);
    }

    .alert-banner.severity-unknown {
      background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
    }

    @keyframes slideDown {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .alert-icon {
      font-size: 1.25rem;
      flex-shrink: 0;
      margin-top: 0.1rem;
      animation: pulse-alert 2s ease-in-out infinite;
    }

    @keyframes pulse-alert {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.6; }
    }

    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }

    .alert-content {
      flex: 1;
      min-width: 0;
    }

    .alert-header {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      flex-wrap: wrap;
      margin-bottom: 0.2rem;
    }

    .alert-title {
      font-weight: 600;
      font-size: 0.9rem;
      letter-spacing: 0.01em;
      color: #fff;
    }

    .alert-severity-badge {
      font-size: 0.6rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      background: rgba(0,0,0,0.25);
      padding: 0.15rem 0.4rem;
      border-radius: 4px;
      color: #fff;
    }

    .alert-description {
      font-size: 0.8rem;
      opacity: 0.95;
      line-height: 1.4;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
      white-space: pre-wrap;
      color: #fff;
    }

    .alert-meta {
      display: flex;
      gap: 0.75rem;
      margin-top: 0.35rem;
      font-size: 0.7rem;
      opacity: 0.85;
      color: #fff;
      flex-wrap: wrap;
    }

    .alert-meta span {
      display: flex;
      align-items: center;
      gap: 0.25rem;
    }

    .alert-dismiss {
      background: rgba(0,0,0,0.2);
      border: none;
      color: white;
      width: 1.75rem;
      height: 1.75rem;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      transition: background 0.2s;
      min-height: 44px;
      min-width: 44px;
    }

    .alert-dismiss:hover {
      background: rgba(0,0,0,0.35);
    }

    .alert-expand-btn {
      background: rgba(0,0,0,0.2);
      border: none;
      color: white;
      padding: 0.2rem 0.6rem;
      border-radius: 4px;
      font-size: 0.7rem;
      cursor: pointer;
      margin-top: 0.35rem;
      transition: background 0.2s;
    }

    .alert-expand-btn:hover {
      background: rgba(0,0,0,0.35);
    }

    .alert-description.expanded {
      -webkit-line-clamp: unset;
    }

    .no-alerts {
      background: rgba(16, 185, 129, 0.1);
      border: 1px solid rgba(16, 185, 129, 0.2);
      border-radius: 12px;
      padding: 0.75rem 1rem;
      display: flex;
      align-items: center;
      gap: 0.75rem;
      color: #10b981;
      font-size: 0.85rem;
      margin-bottom: 0.5rem;
    }

    .no-alerts i {
      font-size: 1.1rem;
    }

    .alerts-loading {
      background: rgba(255,255,255,0.05);
      border-radius: 12px;
      padding: 0.75rem 1rem;
      display: flex;
      align-items: center;
      gap: 0.75rem;
      color: var(--color-text-muted);
      font-size: 0.85rem;
      margin-bottom: 0.5rem;
    }

    /* Cold Weather Shelter Alert Banner */
    .shelter-alert-banner {
      background: linear-gradient(135deg, #1e40af 0%, #7c3aed 100%);
      border: 2px solid #60a5fa;
      border-radius: 12px;
      padding: 1rem;
      margin-bottom: 1.5rem;
      animation: slideDown 0.4s ease-out, pulseGlow 3s ease-in-out infinite;
      position: relative;
      overflow: hidden;
    }

    @keyframes pulseGlow {
      0%, 100% { box-shadow: 0 0 15px rgba(96, 165, 250, 0.3); }
      50% { box-shadow: 0 0 25px rgba(96, 165, 250, 0.6); }
    }

    .shelter-alert-banner::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, #60a5fa, #a78bfa, #60a5fa);
      background-size: 200% 100%;
      animation: shimmer 2s linear infinite;
    }

    @keyframes shimmer {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }

    .shelter-alert-header {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      margin-bottom: 0.75rem;
    }

    .shelter-alert-icon {
      font-size: 1.75rem;
      color: #fbbf24;
      animation: pulse-alert 2s ease-in-out infinite;
    }

    .shelter-alert-title-group {
      flex: 1;
    }

    .shelter-alert-date {
      display: inline-block;
      background: #fbbf24;
      color: #1e3a5f;
      font-size: 0.7rem;
      font-weight: 700;
      padding: 0.2rem 0.5rem;
      border-radius: 4px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 0.25rem;
    }

    .shelter-alert-title {
      font-size: 1rem;
      font-weight: 700;
      color: #fff;
      line-height: 1.3;
    }

    .shelter-alert-status {
      background: #dc2626;
      color: #fff;
      padding: 0.35rem 0.75rem;
      border-radius: 20px;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      animation: pulse-alert 2s ease-in-out infinite;
      white-space: nowrap;
    }

    .shelter-alert-body {
      color: rgba(255,255,255,0.95);
      font-size: 0.85rem;
      line-height: 1.5;
    }

    .shelter-alert-details {
      display: grid;
      gap: 0.5rem;
      margin: 0.75rem 0;
    }

    .shelter-detail-item {
      display: flex;
      align-items: flex-start;
      gap: 0.5rem;
      font-size: 0.85rem;
    }

    .shelter-detail-item i {
      color: #60a5fa;
      font-size: 1rem;
      margin-top: 0.1rem;
      flex-shrink: 0;
    }

    .shelter-alert-cta {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-top: 0.75rem;
      padding-top: 0.75rem;
      border-top: 1px solid rgba(255,255,255,0.2);
    }

    .shelter-cta-btn {
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
      background: rgba(255,255,255,0.15);
      border: 1px solid rgba(255,255,255,0.3);
      color: #fff;
      padding: 0.5rem 0.75rem;
      border-radius: 8px;
      font-size: 0.8rem;
      font-weight: 500;
      text-decoration: none;
      transition: all 0.2s;
      cursor: pointer;
    }

    .shelter-cta-btn:hover {
      background: rgba(255,255,255,0.25);
      transform: translateY(-1px);
    }

    .shelter-cta-btn.primary {
      background: #fbbf24;
      border-color: #fbbf24;
      color: #1e3a5f;
    }

    .shelter-cta-btn.primary:hover {
      background: #fcd34d;
    }

    .shelter-primary-note {
      font-size: 0.75rem;
      color: rgba(255,255,255,0.8);
      margin-top: 0.5rem;
      font-style: italic;
    }

    /* Power Outage Styles */
    .outages-container {
      margin-bottom: 1rem;
    }

    .outage-banner {
      padding: 0.75rem 1rem;
      display: flex;
      align-items: flex-start;
      gap: 0.75rem;
      animation: slideDown 0.4s ease-out;
      border-radius: 12px;
      margin-bottom: 0.5rem;
      background: linear-gradient(135deg, #7c3aed 0%, #5b21b6 100%);
    }

    .outage-banner.assigned {
      background: linear-gradient(135deg, #059669 0%, #047857 100%);
    }

    .outage-icon {
      font-size: 1.25rem;
      flex-shrink: 0;
      margin-top: 0.1rem;
    }

    .outage-icon.unassigned {
      animation: pulse-alert 2s ease-in-out infinite;
    }

    .outage-content {
      flex: 1;
      min-width: 0;
    }

    .outage-header {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      flex-wrap: wrap;
      margin-bottom: 0.2rem;
    }

    .outage-title {
      font-weight: 600;
      font-size: 0.9rem;
      letter-spacing: 0.01em;
      color: #fff;
    }

    .outage-status-badge {
      font-size: 0.6rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      background: rgba(0,0,0,0.25);
      padding: 0.15rem 0.4rem;
      border-radius: 4px;
      color: #fff;
    }

    .outage-description {
      font-size: 0.8rem;
      opacity: 0.95;
      line-height: 1.4;
      color: #fff;
    }

    .outage-meta {
      display: flex;
      gap: 0.75rem;
      margin-top: 0.35rem;
      font-size: 0.7rem;
      opacity: 0.85;
      color: #fff;
      flex-wrap: wrap;
    }

    .outage-meta span {
      display: flex;
      align-items: center;
      gap: 0.25rem;
    }

    .outage-dismiss {
      background: rgba(0,0,0,0.2);
      border: none;
      color: white;
      width: 1.75rem;
      height: 1.75rem;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      transition: background 0.2s;
      min-height: 44px;
      min-width: 44px;
    }

    .outage-dismiss:hover {
      background: rgba(0,0,0,0.35);
    }

    .no-outages {
      background: rgba(16, 185, 129, 0.1);
      border: 1px solid rgba(16, 185, 129, 0.2);
      border-radius: 12px;
      padding: 0.75rem 1rem;
      display: flex;
      align-items: center;
      gap: 0.75rem;
      color: #10b981;
      font-size: 0.85rem;
      margin-bottom: 0.5rem;
    }

    .no-outages i {
      font-size: 1.1rem;
    }

    .outages-loading {
      background: rgba(255,255,255,0.05);
      border-radius: 12px;
      padding: 0.75rem 1rem;
      display: flex;
      align-items: center;
      gap: 0.75rem;
      color: var(--color-text-muted);
      font-size: 0.85rem;
      margin-bottom: 0.5rem;
    }

    .outage-link {
      display: inline-flex;
      align-items: center;
      gap: 0.3rem;
      color: rgba(255,255,255,0.9);
      font-size: 0.7rem;
      text-decoration: none;
      margin-top: 0.35rem;
      padding: 0.2rem 0.5rem;
      background: rgba(0,0,0,0.15);
      border-radius: 4px;
      transition: background 0.2s;
    }

    .outage-link:hover {
      background: rgba(0,0,0,0.3);
      color: #fff;
    }

    .outages-summary {
      background: rgba(124, 58, 237, 0.15);
      border: 1px solid rgba(124, 58, 237, 0.3);
      border-radius: 12px;
      padding: 0.75rem 1rem;
      margin-bottom: 0.5rem;
    }

    .outages-summary-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.5rem;
    }

    .outages-summary-title {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-weight: 600;
      font-size: 0.9rem;
      color: var(--color-text-primary);
    }

    .outages-summary-title i {
      color: #a78bfa;
    }

    .outages-summary-stats {
      display: flex;
      gap: 1rem;
      font-size: 0.75rem;
      color: var(--color-text-secondary);
      margin-top: 0.35rem;
    }

    .outages-summary-link {
      font-size: 0.75rem;
      color: #a78bfa;
      text-decoration: none;
    }

    .outages-summary-link:hover {
      text-decoration: underline;
    }

    .outage-nearby-badge {
      font-size: 0.55rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      background: #10b981;
      padding: 0.15rem 0.4rem;
      border-radius: 4px;
      color: #fff;
    }

    .outage-section-header {
      display: flex;
      align-items: center;
      gap: 0.4rem;
      font-size: 0.75rem;
      font-weight: 600;
      color: var(--color-text-secondary);
      margin: 0.75rem 0 0.4rem 0;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      cursor: pointer;
      user-select: none;
    }

    .outage-section-header:hover {
      color: var(--color-text-primary);
    }

    .outage-section-header i {
      font-size: 0.9rem;
      color: #a78bfa;
    }

    .outage-section-header .toggle-icon {
      margin-left: auto;
      transition: transform 0.2s ease;
    }

    .outage-section-header.collapsed .toggle-icon {
      transform: rotate(-90deg);
    }

    .outage-list-container {
      overflow: hidden;
      transition: max-height 0.3s ease, opacity 0.2s ease;
    }

    .outage-list-container.collapsed {
      max-height: 0 !important;
      opacity: 0;
    }

    .outage-more-text {
      font-size: 0.75rem;
      color: var(--color-text-muted);
      text-align: center;
      padding: 0.5rem;
    }

    .outage-banner.nearby {
      border: 1px solid rgba(16, 185, 129, 0.3);
    }

    .outage-location-controls {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 0.75rem;
      flex-wrap: wrap;
    }

    .outage-location-btn {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      background: rgba(124, 58, 237, 0.15);
      border: 1px solid rgba(124, 58, 237, 0.3);
      color: #a78bfa;
      padding: 0.4rem 0.75rem;
      border-radius: 8px;
      font-size: 0.75rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .outage-location-btn:hover {
      background: rgba(124, 58, 237, 0.25);
      color: #c4b5fd;
    }

    .outage-location-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .outage-location-btn i {
      font-size: 0.9rem;
    }

    .outage-location-status {
      font-size: 0.7rem;
      color: var(--color-text-muted);
      display: flex;
      align-items: center;
      gap: 0.25rem;
    }

    .outage-location-status.success {
      color: #10b981;
    }

    .outage-location-status.error {
      color: #f87171;
    }

    .alerts-loading i {
      font-size: 1.1rem;
      animation: pulse 1.5s ease-in-out infinite;
    }

    [dir="rtl"] .alert-banner {
      flex-direction: row-reverse;
    }

    [dir="rtl"] .alert-header {
      flex-direction: row-reverse;
    }

    [dir="rtl"] .alert-meta {
      flex-direction: row-reverse;
    }

    /* Outage Map Preview Styles */
    .map-preview-section {
      margin-top: 1rem;
    }

    .map-preview-container {
      background: var(--color-surface);
      border: 1px solid var(--color-border);
      border-radius: 12px;
      overflow: hidden;
    }

    .map-preview-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.75rem 1rem;
      background: rgba(0, 0, 0, 0.2);
      border-bottom: 1px solid var(--color-border);
    }

    .map-preview-title {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.9rem;
      font-weight: 600;
      color: var(--color-text-primary);
    }

    .map-preview-title i {
      color: var(--color-accent-blue);
    }

    .map-expand-btn {
      display: flex;
      align-items: center;
      gap: 0.4rem;
      background: var(--color-accent-blue);
      border: none;
      border-radius: 6px;
      padding: 0.5rem 0.75rem;
      color: white;
      font-family: inherit;
      font-size: 0.8rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.15s ease;
      min-height: 36px;
    }

    .map-expand-btn:hover {
      background: #3b82f6;
    }

    .map-expand-btn:active {
      transform: scale(0.98);
    }

    .map-preview-wrapper {
      position: relative;
      height: 200px;
    }

    #outageMapPreview {
      width: 100%;
      height: 100%;
      z-index: 1;
    }

    .map-preview-legend {
      position: absolute;
      bottom: 10px;
      left: 10px;
      z-index: 1000;
      background: rgba(30, 41, 59, 0.95);
      border-radius: 8px;
      padding: 8px 10px;
      font-size: 0.7rem;
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
    }

    [dir="rtl"] .map-preview-legend {
      left: auto;
      right: 10px;
    }

    .map-legend-item {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-bottom: 4px;
      color: #e2e8f0;
    }

    .map-legend-item:last-child {
      margin-bottom: 0;
    }

    .map-legend-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      flex-shrink: 0;
    }

    .map-legend-dot.red { background: #f87171; }
    .map-legend-dot.yellow { background: #fbbf24; }
    .map-legend-dot.green { background: #4ade80; }
    .map-legend-dot.blue { background: #60a5fa; }

    .map-preview-stats {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 1px;
      background: var(--color-border);
    }

    .map-stat {
      background: var(--color-bg-secondary);
      padding: 0.6rem;
      text-align: center;
    }

    .map-stat-value {
      font-size: 1.1rem;
      font-weight: 700;
      font-variant-numeric: tabular-nums;
    }

    .map-stat-value.red { color: #f87171; }
    .map-stat-value.yellow { color: #fbbf24; }
    .map-stat-value.green { color: #4ade80; }

    .map-stat-label {
      font-size: 0.65rem;
      color: var(--color-text-muted);
      margin-top: 2px;
    }

    /* Fullscreen Map Modal */
    .map-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 9999;
      background: var(--color-bg-primary);
    }

    .map-modal.active {
      display: flex;
      flex-direction: column;
    }

    .map-modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 16px;
      background: var(--color-bg-secondary);
      border-bottom: 1px solid var(--color-border);
      flex-shrink: 0;
    }

    .map-modal-title {
      font-size: 1.1rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .map-modal-title i {
      color: var(--color-accent-blue);
    }

    .map-modal-close {
      background: var(--color-surface);
      border: 1px solid var(--color-border);
      border-radius: 8px;
      color: var(--color-text-primary);
      width: 44px;
      height: 44px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.15s ease;
      font-size: 1.25rem;
    }

    .map-modal-close:hover {
      background: var(--color-surface-hover);
    }

    .map-modal-stats {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 1px;
      background: var(--color-border);
      flex-shrink: 0;
    }

    .map-modal-stat {
      background: var(--color-bg-secondary);
      padding: 12px;
      text-align: center;
    }

    .map-modal-stat-value {
      font-size: 1.5rem;
      font-weight: 700;
      font-variant-numeric: tabular-nums;
    }

    .map-modal-stat-value.red { color: #f87171; }
    .map-modal-stat-value.yellow { color: #fbbf24; }
    .map-modal-stat-value.green { color: #4ade80; }

    .map-modal-stat-label {
      font-size: 0.75rem;
      color: var(--color-text-muted);
      margin-top: 4px;
    }

    .map-modal-body {
      flex: 1;
      position: relative;
      min-height: 0;
    }

    #outageMapFull {
      width: 100%;
      height: 100%;
    }

    .map-modal-legend {
      position: absolute;
      bottom: 80px;
      left: 10px;
      z-index: 1000;
      background: rgba(30, 41, 59, 0.95);
      border-radius: 8px;
      padding: 12px;
      font-size: 0.8rem;
      box-shadow: 0 2px 10px rgba(0,0,0,0.3);
    }

    [dir="rtl"] .map-modal-legend {
      left: auto;
      right: 10px;
    }

    .map-modal-legend-title {
      font-weight: 600;
      margin-bottom: 8px;
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: #94a3b8;
    }

    .map-modal-legend-item {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 6px;
      color: #e2e8f0;
    }

    .map-modal-legend-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      flex-shrink: 0;
    }

    .map-modal-legend-dot.red { background: #f87171; }
    .map-modal-legend-dot.yellow { background: #fbbf24; }
    .map-modal-legend-dot.green { background: #4ade80; }
    .map-modal-legend-dot.blue { background: #60a5fa; }

    .map-modal-footer {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1px;
      background: var(--color-border);
      flex-shrink: 0;
    }

    .map-modal-action {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      padding: 16px;
      background: var(--color-bg-secondary);
      border: none;
      color: var(--color-text-primary);
      font-family: inherit;
      font-size: 0.9rem;
      font-weight: 500;
      text-decoration: none;
      cursor: pointer;
      transition: background 0.15s ease;
    }

    .map-modal-action:hover {
      background: var(--color-surface-hover);
    }

    .map-modal-action.primary {
      background: var(--color-accent-blue);
      color: white;
    }

    .map-modal-action.primary:hover {
      background: #3b82f6;
    }

    /* Leaflet popup customization */
    .leaflet-popup-content-wrapper {
      background: #1e293b;
      color: #f1f5f9;
      border-radius: 8px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.3);
    }

    .leaflet-popup-tip {
      background: #1e293b;
    }

    .outage-popup {
      padding: 4px;
    }

    .outage-popup-status {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .outage-popup-status.assigned {
      background: rgba(74, 222, 128, 0.2);
      color: #4ade80;
    }

    .outage-popup-status.unassigned {
      background: rgba(248, 113, 113, 0.2);
      color: #f87171;
    }

    .outage-popup-status.working {
      background: rgba(251, 191, 36, 0.2);
      color: #fbbf24;
    }

    .outage-popup-info {
      font-size: 0.875rem;
      color: #94a3b8;
      line-height: 1.5;
    }

    .warming-center-icon {
      background: #2563eb;
      border-radius: 50%;
      width: 28px;
      height: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      border: 2px solid white;
      box-shadow: 0 2px 6px rgba(0,0,0,0.4);
    }

    .warming-popup-title {
      font-weight: 600;
      font-size: 0.95rem;
      margin-bottom: 6px;
      color: #f1f5f9;
    }

    .warming-popup-status {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 10px;
      font-size: 0.7rem;
      font-weight: 600;
      background: rgba(74, 222, 128, 0.2);
      color: #4ade80;
      margin-bottom: 6px;
    }

    .warming-popup-status.unconfirmed {
      background: rgba(251, 191, 36, 0.2);
      color: #fbbf24;
    }

    @media (max-width: 400px) {
      .map-preview-header {
        flex-direction: column;
        gap: 0.5rem;
        align-items: stretch;
      }

      .map-expand-btn {
        justify-content: center;
      }

      .map-stat-value {
        font-size: 1rem;
      }

      .map-modal-stat-value {
        font-size: 1.25rem;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="top-bar">
      <div class="lang-select">
        <button class="lang-btn active" data-lang="en">EN</button>
        <button class="lang-btn" data-lang="es">ES</button>
        <button class="lang-btn" data-lang="ar">العربية</button>
        <button class="lang-btn" data-lang="ku">کوردی</button>
        <button class="lang-btn" data-lang="vi">VI</button>
      </div>
      <button class="a11y-toggle" id="textSizeToggle" aria-label="Change text size" title="Change text size">Aa</button>
    </div>

    <header>
      <div class="branding">
        <img src="https://assets.softr-files.com/applications/26b1b861-7748-4f49-8539-21dc6ca9c679/assets/58e44c7c-d691-468e-a9c0-68bfe0c8fd21.png" alt="Nashville Resources Logo" class="app-logo">
        <div class="title-group">
          <h1 data-i18n="title">Nashville Winter Resources</h1>
          <p class="subtitle" data-i18n="subtitle">Shelter, food & support during extreme weather</p>
        </div>
      </div>

      <a href="emergency.html" class="location-btn">
        <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
          <path stroke-linecap="round" stroke-linejoin="round" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
        </svg>
        <span data-i18n="get_location_911">Get My Location for 911</span>
      </a>
    </header>

    <!-- Cold Weather Shelter Alert -->
    <div class="shelter-alert-banner" role="alert" aria-live="polite">
      <div class="shelter-alert-header">
        <i class="ph ph-warning-circle shelter-alert-icon"></i>
        <div class="shelter-alert-title-group">
          <span class="shelter-alert-date" data-i18n="shelter_alert_date">January 30, 2026 Update</span>
          <div class="shelter-alert-title" data-i18n="shelter_alert_title">Metro Emergency Overflow Shelter</div>
        </div>
        <span class="shelter-alert-status" data-i18n="shelter_alert_status">Open 24 Hours</span>
      </div>
      <div class="shelter-alert-body">
        <div class="shelter-alert-details">
          <div class="shelter-detail-item">
            <i class="ph ph-map-pin"></i>
            <span data-i18n="shelter_alert_location">3230 Brick Church Pike, Nashville</span>
          </div>
          <div class="shelter-detail-item">
            <i class="ph ph-users"></i>
            <span data-i18n="shelter_alert_who">Adults 18+, couples, pets welcome (kennels provided)</span>
          </div>
          <div class="shelter-detail-item">
            <i class="ph ph-bowl-food"></i>
            <span data-i18n="shelter_alert_services">Hot meals, snacks, mats/cots, showers</span>
          </div>
          <div class="shelter-detail-item">
            <i class="ph ph-bus"></i>
            <span data-i18n="shelter_alert_transport">Free WeGo Bus Line #23B from WeGo Central after 7pm</span>
          </div>
        </div>
        <div class="shelter-alert-cta">
          <a href="sms:888-777?body=OHSALERT" class="shelter-cta-btn primary">
            <i class="ph ph-chat-text"></i>
            <span data-i18n="shelter_alert_text">Text OHSALERT to 888-777</span>
          </a>
          <a href="tel:615-862-6391" class="shelter-cta-btn">
            <i class="ph ph-phone"></i>
            <span>615-862-6391</span>
          </a>
          <a href="https://www.nashville.gov/departments/office-homeless-services/get-connected/extreme-weather" class="shelter-cta-btn" target="_blank" rel="noopener noreferrer">
            <i class="ph ph-arrow-square-out"></i>
            <span data-i18n="shelter_alert_more">Official Info</span>
          </a>
        </div>
        <p class="shelter-primary-note" data-i18n="shelter_alert_note">Primary shelters: Room In The Inn, Nashville Rescue Mission, Launch Pad, Oasis. Try primary shelters first.</p>
      </div>
    </div>

    <section class="section">
      <div class="section-title" data-i18n="start">Start Here</div>
      <div class="links">
        <a href="https://wttin.org/" class="link featured external-link" target="_blank" rel="noopener noreferrer" data-href="https://wttin.org/">
          <i class="ph ph-compass"></i>
          <span data-i18n="wttin">Where to Turn in Nashville</span>
        </a>
      </div>
    </section>

    <section class="section">
      <div class="section-title" data-i18n="weather_alerts">Weather Alerts</div>
      <div class="alerts-container" id="alertsContainer">
        <div class="alerts-loading">
          <i class="ph ph-cloud"></i>
          <span data-i18n="loading_alerts">Checking for alerts...</span>
        </div>
      </div>
    </section>

    <section class="section">
      <div class="section-title" data-i18n="power_outages">Power Outages</div>
      <div class="outage-location-controls">
        <button class="outage-location-btn" id="outageLocationBtn" onclick="useMyLocationForOutages()">
          <i class="ph ph-crosshair"></i>
          <span data-i18n="outage_use_location">Use My Location</span>
        </button>
        <span class="outage-location-status" id="outageLocationStatus"></span>
      </div>
      <div class="outages-container" id="outagesContainer">
        <div class="outages-loading">
          <i class="ph ph-lightning"></i>
          <span data-i18n="loading_outages">Checking NES outages...</span>
        </div>
      </div>

      <!-- Map Preview -->
      <div class="map-preview-section">
        <div class="map-preview-container">
          <div class="map-preview-header">
            <div class="map-preview-title">
              <i class="ph ph-map-trifold"></i>
              <span data-i18n="map_outage_map">Outage Map</span>
            </div>
            <button class="map-expand-btn" onclick="openMapModal()">
              <i class="ph ph-arrows-out"></i>
              <span data-i18n="map_fullscreen">Full Screen</span>
            </button>
          </div>
          <div class="map-preview-wrapper">
            <div id="outageMapPreview"></div>
            <div class="map-preview-legend">
              <div class="map-legend-item">
                <div class="map-legend-dot red"></div>
                <span data-i18n="map_legend_waiting">Waiting</span>
              </div>
              <div class="map-legend-item">
                <div class="map-legend-dot yellow"></div>
                <span data-i18n="map_legend_assigned">Assigned</span>
              </div>
              <div class="map-legend-item">
                <div class="map-legend-dot green"></div>
                <span data-i18n="map_legend_working">Repairing</span>
              </div>
              <div class="map-legend-item">
                <div class="map-legend-dot blue"></div>
                <span data-i18n="map_legend_warming">Warming</span>
              </div>
            </div>
          </div>
          <div class="map-preview-stats">
            <div class="map-stat">
              <div class="map-stat-value red" id="mapStatCustomers">--</div>
              <div class="map-stat-label" data-i18n="map_stat_affected">Affected</div>
            </div>
            <!-- Hidden until crew/waiting data is verified
            <div class="map-stat">
              <div class="map-stat-value green" id="mapStatCrews">--</div>
              <div class="map-stat-label" data-i18n="map_stat_crews">Crews</div>
            </div>
            <div class="map-stat">
              <div class="map-stat-value yellow" id="mapStatWaiting">--</div>
              <div class="map-stat-label" data-i18n="map_stat_waiting">Waiting</div>
            </div>
            -->
          </div>
        </div>
      </div>
    </section>

    <section class="forecast-section">
      <div class="forecast-header">
        <div class="section-title" data-i18n="forecast">5-Day Forecast</div>
        <div class="zip-input-wrapper">
          <i class="ph ph-map-pin"></i>
          <input type="text" id="zipInput" placeholder="37206" maxlength="5" value="37206" inputmode="numeric" pattern="[0-9]*">
          <button id="fetchBtn" data-i18n="update_btn">Go</button>
        </div>
      </div>
      <p class="location-display" id="locationDisplay"></p>
      <div class="forecast-grid" id="forecastGrid">
        <div class="forecast-loading">
          <i class="ph ph-cloud"></i>
          <p data-i18n="loading_forecast">Loading forecast...</p>
        </div>
      </div>
    </section>

    <section class="section">
      <div class="section-title" data-i18n="official">Official Resource Hubs</div>
      <div class="links">
        <a href="https://www.nashville.gov/departments/emergency-management/news/january-27-winter-weather-update" class="link external-link" target="_blank" rel="noopener noreferrer" data-href="https://www.nashville.gov/departments/emergency-management/news/january-27-winter-weather-update">
          <i class="ph ph-cloud-snow"></i>
          <span data-i18n="nashville_weather">Nashville.gov Winter Weather Updates</span>
        </a>
        <a href="https://www.nashville.gov/departments/office-homeless-services/get-connected/extreme-weather" class="link external-link" target="_blank" rel="noopener noreferrer" data-href="https://www.nashville.gov/departments/office-homeless-services/get-connected/extreme-weather">
          <i class="ph ph-thermometer-cold"></i>
          <span data-i18n="ohs_extreme">Metro OHS – Extreme Weather</span>
        </a>
        <a href="https://www.nashville.gov/departments/office-homeless-services/get-connected/extreme-weather/shelters" class="link external-link" target="_blank" rel="noopener noreferrer" data-href="https://www.nashville.gov/departments/office-homeless-services/get-connected/extreme-weather/shelters">
          <i class="ph ph-list-bullets"></i>
          <span data-i18n="shelter_list">Metro Shelter List</span>
        </a>
        <a href="https://www.tn.gov/tema/tennessee-shelters.html" class="link external-link" target="_blank" rel="noopener noreferrer" data-href="https://www.tn.gov/tema/tennessee-shelters.html">
          <i class="ph ph-map-trifold"></i>
          <span data-i18n="tema_map">TEMA Statewide Shelter Map</span>
        </a>
        <a href="https://www.tn.gov/tema/updates/2026-disasters/january-2026-winter-weather.html" class="link external-link" target="_blank" rel="noopener noreferrer" data-href="https://www.tn.gov/tema/updates/2026-disasters/january-2026-winter-weather.html">
          <i class="ph ph-warning"></i>
          <span data-i18n="tema_hub">TEMA Winter Weather Hub</span>
        </a>
        <a href="https://www.fema.gov/disaster/2026-winter-storm" class="link external-link" target="_blank" rel="noopener noreferrer" data-href="https://www.fema.gov/disaster/2026-winter-storm">
          <i class="ph ph-flag"></i>
          <span data-i18n="fema">FEMA 2026 Winter Storm</span>
        </a>
      </div>
    </section>
    
    <section class="section">
      <div class="section-title" data-i18n="shelter">Shelter & Outreach</div>
      <div class="links">
        <a href="https://www.roomintheinn.org/" class="link external-link" target="_blank" rel="noopener noreferrer" data-href="https://www.roomintheinn.org/">
          <i class="ph ph-bed"></i>
          <span>Room in the Inn</span>
        </a>
        <a href="https://www.opentablenashville.org/" class="link external-link" target="_blank" rel="noopener noreferrer" data-href="https://www.opentablenashville.org/">
          <i class="ph ph-hand-heart"></i>
          <span>Open Table Nashville</span>
        </a>
        <a href="https://thecontributor.org/" class="link external-link" target="_blank" rel="noopener noreferrer" data-href="https://thecontributor.org/">
          <i class="ph ph-newspaper"></i>
          <span>The Contributor</span>
        </a>
        <a href="https://www.peoplelovingnashville.com/" class="link external-link" target="_blank" rel="noopener noreferrer" data-href="https://www.peoplelovingnashville.com/">
          <i class="ph ph-users"></i>
          <span>People Loving Nashville</span>
        </a>
      </div>
    </section>
    
    <section class="section">
      <div class="section-title" data-i18n="food">Food</div>
      <div class="links">
        <a href="https://www.secondharvestmidtn.org/" class="link external-link" target="_blank" rel="noopener noreferrer" data-href="https://www.secondharvestmidtn.org/">
          <i class="ph ph-package"></i>
          <span data-i18n="second_harvest">Second Harvest Food Bank</span>
        </a>
        <a href="https://www.secondharvestmidtn.org/find-resources/find-food/" class="link external-link" target="_blank" rel="noopener noreferrer" data-href="https://www.secondharvestmidtn.org/find-resources/find-food/">
          <i class="ph ph-magnifying-glass"></i>
          <span data-i18n="find_food">Second Harvest – Find Food</span>
        </a>
        <a href="https://dreamstreetstn.com/mobilefood" class="link external-link" target="_blank" rel="noopener noreferrer" data-href="https://dreamstreetstn.com/mobilefood">
          <i class="ph ph-truck"></i>
          <span data-i18n="dream_streets">Dream Streets Mobile Food</span>
        </a>
      </div>
    </section>
    
    <section class="section">
      <div class="section-title" data-i18n="immigrant">Immigrant Community</div>
      <div class="links">
        <a href="https://www.conexionamericas.org/" class="link external-link" target="_blank" rel="noopener noreferrer" data-href="https://www.conexionamericas.org/">
          <i class="ph ph-globe-hemisphere-west"></i>
          <span>Conexión Américas / Casa Azafrán</span>
        </a>
      </div>
    </section>
    
    <section class="section">
      <div class="section-title" data-i18n="legal">Legal & Other Resources</div>
      <div class="links">
        <a href="https://las.org/" class="link external-link" target="_blank" rel="noopener noreferrer" data-href="https://las.org/">
          <i class="ph ph-scales"></i>
          <span data-i18n="legal_aid">Legal Aid Society of Middle TN</span>
        </a>
        <a href="https://www.wnpt.org/agingmatters/unhoused/" class="link external-link" target="_blank" rel="noopener noreferrer" data-href="https://www.wnpt.org/agingmatters/unhoused/">
          <i class="ph ph-info"></i>
          <span data-i18n="npt">NPT Unhoused Resources</span>
        </a>
      </div>
    </section>
    
    <div class="outreach">
      <div class="outreach-label" data-i18n="outreach_label">Homeless Outreach Hotline</div>
      <a href="tel:6158629400" class="outreach-number">615-862-9400</a>
    </div>

    <footer>
      <span data-i18n="footer">Share widely · Updated Jan 2026</span>
      <p style="margin-top: 0.75rem;">Brought to you by <a href="https://readrichtext.substack.com/" target="_blank" rel="noopener" style="color: var(--color-link);">Rich Text</a> and <a href="https://groundtruthnashville.substack.com/" target="_blank" rel="noopener" style="color: var(--color-link);">Ground Truth Nashville</a></p>
      <p style="margin-top: 0.5rem; font-size: 0.7rem; color: var(--color-text-muted);">NES outage data powered by <a href="https://github.com/NeckBeardPrince/nes-outage-status-checker" target="_blank" rel="noopener" style="color: var(--color-text-muted);">NeckBeardPrince/nes-outage-status-checker</a></p>
    </footer>
  </div>

  <!-- Fullscreen Map Modal -->
  <div class="map-modal" id="mapModal">
    <div class="map-modal-header">
      <div class="map-modal-title">
        <i class="ph ph-map-trifold"></i>
        <span data-i18n="map_outage_map">Outage Map</span>
      </div>
      <button class="map-modal-close" onclick="closeMapModal()">
        <i class="ph ph-x"></i>
      </button>
    </div>
    <div class="map-modal-stats">
      <div class="map-modal-stat">
        <div class="map-modal-stat-value red" id="modalStatCustomers">--</div>
        <div class="map-modal-stat-label" data-i18n="map_stat_affected">Affected</div>
      </div>
      <!-- Hidden until crew/waiting data is verified
      <div class="map-modal-stat">
        <div class="map-modal-stat-value green" id="modalStatCrews">--</div>
        <div class="map-modal-stat-label" data-i18n="map_stat_crews">Crews</div>
      </div>
      <div class="map-modal-stat">
        <div class="map-modal-stat-value yellow" id="modalStatWaiting">--</div>
        <div class="map-modal-stat-label" data-i18n="map_stat_waiting">Waiting</div>
      </div>
      -->
    </div>
    <div class="map-modal-body">
      <div id="outageMapFull"></div>
      <div class="map-modal-legend">
        <div class="map-modal-legend-title" data-i18n="map_legend_title">Map Key</div>
        <div class="map-modal-legend-item">
          <div class="map-modal-legend-dot red"></div>
          <span data-i18n="map_legend_waiting">Waiting for crew</span>
        </div>
        <div class="map-modal-legend-item">
          <div class="map-modal-legend-dot yellow"></div>
          <span data-i18n="map_legend_assigned">Crew assigned</span>
        </div>
        <div class="map-modal-legend-item">
          <div class="map-modal-legend-dot green"></div>
          <span data-i18n="map_legend_working">Being repaired</span>
        </div>
        <div class="map-modal-legend-item">
          <div class="map-modal-legend-dot blue"></div>
          <span data-i18n="map_legend_warming">Warming center</span>
        </div>
      </div>
    </div>
    <div class="map-modal-footer">
      <a href="https://nespower.com/outages" target="_blank" rel="noopener noreferrer" class="map-modal-action">
        <i class="ph ph-chart-line"></i>
        <span data-i18n="map_nes_website">NES Website</span>
      </a>
      <a href="tel:615-234-0000" class="map-modal-action primary">
        <i class="ph ph-phone"></i>
        <span data-i18n="map_report_outage">Report Outage</span>
      </a>
    </div>
  </div>

  <script>
    // Store data for re-rendering on language change
    let cachedWeatherData = null;
    let cachedAlertsData = null;
    let cachedOutagesData = null;

    // ===========================================
    // WEBHOOK ACTIVITY TRACKING
    // ===========================================
    const WEBHOOK_URL = 'https://n8n.intelechia.com/webhook/dc4ce521-1f11-4e5a-8850-e38b1d3b3f39';

    function trackActivity(action, details = {}) {
      try {
        const payload = {
          page: 'index',
          action: action,
          details: details,
          timestamp: new Date().toISOString(),
          language: localStorage.getItem('nashville-resources-lang') || 'en',
          userAgent: navigator.userAgent,
          referrer: document.referrer || null
        };

        console.log('[Webhook] Sending:', action, payload);

        fetch(WEBHOOK_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
          keepalive: true
        })
        .then(response => {
          console.log('[Webhook] Response:', response.status, response.statusText);
          if (!response.ok) {
            console.error('[Webhook] Failed with status:', response.status);
          }
        })
        .catch(error => {
          console.error('[Webhook] Error:', error.message || error);
        });
      } catch (e) {
        console.error('[Webhook] Exception:', e);
      }
    }

    // Track page load
    trackActivity('page_load', { url: window.location.href });

    // ===========================================
    // TRANSLATION CACHE (localStorage persistence)
    // ===========================================
    const translationCache = new Map();
    const CACHE_KEY = 'nashville_alert_translations_v1';
    const CACHE_EXPIRY_DAYS = 30;

    function loadTranslationCache() {
      try {
        const stored = localStorage.getItem(CACHE_KEY);
        if (stored) {
          const { data, timestamp } = JSON.parse(stored);
          const age = Date.now() - timestamp;
          if (age < CACHE_EXPIRY_DAYS * 24 * 60 * 60 * 1000) {
            Object.entries(data).forEach(([k, v]) => translationCache.set(k, v));
            console.log(`Loaded ${Object.keys(data).length} cached translations`);
          } else {
            localStorage.removeItem(CACHE_KEY);
          }
        }
      } catch (e) {
        console.warn('Failed to load translation cache:', e);
      }
    }

    function saveTranslationCache() {
      try {
        const data = Object.fromEntries(translationCache);
        localStorage.setItem(CACHE_KEY, JSON.stringify({
          data,
          timestamp: Date.now()
        }));
      } catch (e) {
        console.warn('Failed to save translation cache:', e);
      }
    }

    // Load cache on startup
    loadTranslationCache();

    // ===========================================
    // PRE-TRANSLATED NWS ALERT TYPES
    // ===========================================
    const alertTranslations = {
      es: {
        'Tornado Warning': 'Advertencia de Tornado',
        'Tornado Watch': 'Vigilancia de Tornado',
        'Severe Thunderstorm Warning': 'Advertencia de Tormenta Severa',
        'Severe Thunderstorm Watch': 'Vigilancia de Tormenta Severa',
        'Flash Flood Warning': 'Advertencia de Inundación Repentina',
        'Flash Flood Watch': 'Vigilancia de Inundación Repentina',
        'Flood Warning': 'Advertencia de Inundación',
        'Flood Watch': 'Vigilancia de Inundación',
        'Flood Advisory': 'Aviso de Inundación',
        'Winter Storm Warning': 'Advertencia de Tormenta Invernal',
        'Winter Storm Watch': 'Vigilancia de Tormenta Invernal',
        'Winter Weather Advisory': 'Aviso de Clima Invernal',
        'Blizzard Warning': 'Advertencia de Ventisca',
        'Ice Storm Warning': 'Advertencia de Tormenta de Hielo',
        'Wind Chill Warning': 'Advertencia de Sensación Térmica',
        'Wind Chill Watch': 'Vigilancia de Sensación Térmica',
        'Wind Chill Advisory': 'Aviso de Sensación Térmica',
        'Cold Weather Advisory': 'Aviso de Clima Frío',
        'Freeze Warning': 'Advertencia de Helada',
        'Freeze Watch': 'Vigilancia de Helada',
        'Frost Advisory': 'Aviso de Escarcha',
        'Hard Freeze Warning': 'Advertencia de Helada Intensa',
        'Hard Freeze Watch': 'Vigilancia de Helada Intensa',
        'Excessive Heat Warning': 'Advertencia de Calor Excesivo',
        'Excessive Heat Watch': 'Vigilancia de Calor Excesivo',
        'Heat Advisory': 'Aviso de Calor',
        'Hurricane Warning': 'Advertencia de Huracán',
        'Hurricane Watch': 'Vigilancia de Huracán',
        'Tropical Storm Warning': 'Advertencia de Tormenta Tropical',
        'Tropical Storm Watch': 'Vigilancia de Tormenta Tropical',
        'High Wind Warning': 'Advertencia de Vientos Fuertes',
        'High Wind Watch': 'Vigilancia de Vientos Fuertes',
        'Wind Advisory': 'Aviso de Viento',
        'Dense Fog Advisory': 'Aviso de Niebla Densa',
        'Fire Warning': 'Advertencia de Incendio',
        'Red Flag Warning': 'Advertencia de Bandera Roja',
        'Special Weather Statement': 'Comunicado Especial del Tiempo',
        'Hazardous Weather Outlook': 'Perspectiva de Clima Peligroso',
        'Air Quality Alert': 'Alerta de Calidad del Aire'
      },
      ar: {
        'Tornado Warning': 'تحذير من إعصار',
        'Tornado Watch': 'مراقبة إعصار',
        'Severe Thunderstorm Warning': 'تحذير من عاصفة رعدية شديدة',
        'Flash Flood Warning': 'تحذير من فيضان مفاجئ',
        'Flood Warning': 'تحذير من فيضان',
        'Winter Storm Warning': 'تحذير من عاصفة شتوية',
        'Winter Weather Advisory': 'تنبيه طقس شتوي',
        'Blizzard Warning': 'تحذير من عاصفة ثلجية',
        'Cold Weather Advisory': 'تنبيه طقس بارد',
        'Freeze Warning': 'تحذير من تجمد',
        'Heat Advisory': 'تنبيه حرارة',
        'Excessive Heat Warning': 'تحذير من حرارة شديدة',
        'High Wind Warning': 'تحذير من رياح قوية',
        'Wind Advisory': 'تنبيه رياح',
        'Dense Fog Advisory': 'تنبيه ضباب كثيف',
        'Fire Warning': 'تحذير من حريق',
        'Air Quality Alert': 'تنبيه جودة الهواء'
      },
      ku: {
        'Tornado Warning': 'ئاگاداری تۆرنادۆ',
        'Severe Thunderstorm Warning': 'ئاگاداری بروسکە توند',
        'Flash Flood Warning': 'ئاگاداری لافاوی کاتی',
        'Flood Warning': 'ئاگاداری لافاو',
        'Winter Storm Warning': 'ئاگاداری زریانی زستان',
        'Winter Weather Advisory': 'ڕاوێژی کەشوهەوای زستان',
        'Blizzard Warning': 'ئاگاداری بۆران',
        'Cold Weather Advisory': 'ڕاوێژی کەشوهەوای سارد',
        'Freeze Warning': 'ئاگاداری بەستن',
        'Heat Advisory': 'ڕاوێژی گەرما',
        'High Wind Warning': 'ئاگاداری با بەهێز',
        'Fire Warning': 'ئاگاداری ئاگر',
        'Air Quality Alert': 'ئاگاداری کوالیتی هەوا'
      },
      vi: {
        'Tornado Warning': 'Cảnh báo Lốc Xoáy',
        'Tornado Watch': 'Theo dõi Lốc Xoáy',
        'Severe Thunderstorm Warning': 'Cảnh báo Dông Bão Mạnh',
        'Flash Flood Warning': 'Cảnh báo Lũ Quét',
        'Flood Warning': 'Cảnh báo Lũ Lụt',
        'Winter Storm Warning': 'Cảnh báo Bão Mùa Đông',
        'Winter Weather Advisory': 'Khuyến cáo Thời tiết Mùa Đông',
        'Blizzard Warning': 'Cảnh báo Bão Tuyết',
        'Cold Weather Advisory': 'Khuyến cáo Thời tiết Lạnh',
        'Freeze Warning': 'Cảnh báo Đóng Băng',
        'Frost Advisory': 'Khuyến cáo Sương Giá',
        'Heat Advisory': 'Khuyến cáo Nóng',
        'Excessive Heat Warning': 'Cảnh báo Nóng Cực Độ',
        'High Wind Warning': 'Cảnh báo Gió Mạnh',
        'Wind Advisory': 'Khuyến cáo Gió',
        'Dense Fog Advisory': 'Khuyến cáo Sương Mù Dày',
        'Fire Warning': 'Cảnh báo Cháy Rừng',
        'Red Flag Warning': 'Cảnh báo Cờ Đỏ',
        'Air Quality Alert': 'Cảnh báo Chất lượng Không khí'
      }
    };

    // Look up pre-translated alert type
    function getPreTranslatedAlert(alertType, lang) {
      if (lang === 'en' || !alertType) return null;
      const langAlerts = alertTranslations[lang];
      return langAlerts && langAlerts[alertType] ? langAlerts[alertType] : null;
    }

    // ===========================================
    // TRANSLATION FALLBACK CHAIN
    // Priority: Pre-translated → Cache → MyMemory → LibreTranslate → English
    // ===========================================
    async function tryMyMemory(text, targetLang) {
      const truncated = text.substring(0, 450);
      const encoded = encodeURIComponent(truncated);
      const response = await fetch(
        `https://api.mymemory.translated.net/get?q=${encoded}&langpair=en|${targetLang}`
      );
      if (!response.ok) throw new Error('MyMemory API error');
      const data = await response.json();
      if (data.responseStatus === 429 ||
          (data.responseData?.translatedText || '').includes('MYMEMORY WARNING')) {
        throw new Error('MyMemory rate limited');
      }
      if (data.responseStatus === 200 && data.responseData?.translatedText) {
        let translated = data.responseData.translatedText;
        if (translated === translated.toUpperCase() && translated.length > 10) {
          translated = translated.charAt(0) + translated.slice(1).toLowerCase();
        }
        return translated;
      }
      throw new Error('MyMemory no translation');
    }

    async function tryLibreTranslate(text, targetLang) {
      const instances = [
        'https://libretranslate.com',
        'https://translate.argosopentech.com',
        'https://translate.terraprint.co'
      ];
      const truncated = text.substring(0, 450);
      for (const instance of instances) {
        try {
          const response = await fetch(`${instance}/translate`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ q: truncated, source: 'en', target: targetLang, format: 'text' })
          });
          if (response.ok) {
            const data = await response.json();
            if (data.translatedText) return data.translatedText;
          }
        } catch (e) { continue; }
      }
      throw new Error('LibreTranslate all instances failed');
    }

    async function translateText(text, targetLang) {
      if (!text || targetLang === 'en') return text;

      // 1. Check pre-translated alert types (instant)
      const preTranslated = getPreTranslatedAlert(text, targetLang);
      if (preTranslated) return preTranslated;

      // 2. Check cache
      const cacheKey = `${text.substring(0, 100)}|${targetLang}`;
      if (translationCache.has(cacheKey)) return translationCache.get(cacheKey);

      // 3. Try MyMemory API
      try {
        const translated = await tryMyMemory(text, targetLang);
        translationCache.set(cacheKey, translated);
        saveTranslationCache();
        return translated;
      } catch (err) {
        console.warn('MyMemory failed:', err.message);
      }

      // 4. Try LibreTranslate
      try {
        const translated = await tryLibreTranslate(text, targetLang);
        translationCache.set(cacheKey, translated);
        saveTranslationCache();
        return translated;
      } catch (err) {
        console.warn('LibreTranslate failed:', err.message);
      }

      // 5. Return original English
      return text;
    }

    const translations = {
      en: {
        title: "Nashville Winter Resources",
        subtitle: "Shelter, food & support during extreme weather",
        emergency_911: "911 Location",
        start: "Start Here",
        wttin: "Where to Turn in Nashville",
        official: "Official Resource Hubs",
        nashville_weather: "Nashville.gov Winter Weather Updates",
        ohs_extreme: "Metro OHS – Extreme Weather",
        shelter_list: "Metro Shelter List",
        tema_map: "TEMA Statewide Shelter Map",
        tema_hub: "TEMA Winter Weather Hub",
        fema: "FEMA 2026 Winter Storm",
        shelter: "Shelter & Outreach",
        food: "Food",
        second_harvest: "Second Harvest Food Bank",
        find_food: "Second Harvest – Find Food",
        dream_streets: "Dream Streets Mobile Food",
        immigrant: "Immigrant Community",
        legal: "Legal & Other Resources",
        legal_aid: "Legal Aid Society of Middle TN",
        npt: "NPT Unhoused Resources",
        footer: "Share widely · Updated Jan 2026",
        forecast: "5-Day Forecast",
        update_btn: "Go",
        loading_forecast: "Loading forecast...",
        invalid_zip: "Please enter a valid 5-digit ZIP code",
        forecast_error: "Unable to fetch forecast. Please check the ZIP code.",
        weather_unknown: "Unknown",
        day_sun: "Sun", day_mon: "Mon", day_tue: "Tue", day_wed: "Wed", day_thu: "Thu", day_fri: "Fri", day_sat: "Sat",
        month_jan: "Jan", month_feb: "Feb", month_mar: "Mar", month_apr: "Apr", month_may: "May", month_jun: "Jun",
        month_jul: "Jul", month_aug: "Aug", month_sep: "Sep", month_oct: "Oct", month_nov: "Nov", month_dec: "Dec",
        weather_0: "Clear Sky", weather_1: "Mostly Clear", weather_2: "Partly Cloudy", weather_3: "Overcast",
        weather_45: "Foggy", weather_48: "Rime Fog",
        weather_51: "Light Drizzle", weather_53: "Moderate Drizzle", weather_55: "Dense Drizzle",
        weather_56: "Freezing Drizzle", weather_57: "Heavy Freezing Drizzle",
        weather_61: "Light Rain", weather_63: "Moderate Rain", weather_65: "Heavy Rain",
        weather_66: "Freezing Rain", weather_67: "Heavy Freezing Rain",
        weather_71: "Light Snow", weather_73: "Moderate Snow", weather_75: "Heavy Snow", weather_77: "Snow Grains",
        weather_80: "Light Showers", weather_81: "Moderate Showers", weather_82: "Violent Showers",
        weather_85: "Light Snow Showers", weather_86: "Heavy Snow Showers",
        weather_95: "Thunderstorm", weather_96: "Thunderstorm with Hail", weather_99: "Severe Thunderstorm",
        weather_alerts: "Weather Alerts",
        loading_alerts: "Checking for alerts...",
        no_alerts: "No active weather alerts for this area",
        alert_effective: "Effective",
        alert_expires: "Expires",
        alert_show_details: "Show Details",
        alert_hide_details: "Hide Details",
        severity_extreme: "Extreme",
        severity_severe: "Severe",
        severity_moderate: "Moderate",
        severity_minor: "Minor",
        severity_unknown: "Unknown",
        get_location_911: "Get My Location for 911",
        outreach_label: "Homeless Outreach Hotline",
        power_outages: "Power Outages",
        loading_outages: "Checking NES outages...",
        no_outages: "No active power outages reported",
        outage_customers: "Customers affected",
        outage_started: "Started",
        outage_cause: "Cause",
        outage_assigned: "Crew Assigned",
        outage_unassigned: "Awaiting Crew",
        outage_view_map: "View NES Map",
        outages_total: "Total outages",
        outages_customers: "customers affected",
        outages_nearby: "near you",
        outages_near_you: "Near You",
        outages_other_areas: "Other Areas",
        outages_more_nearby: "more nearby",
        outage_miles: "mi away",
        outage_nearby: "Nearby",
        outage_view_all: "View all",
        outages_on_map: "outages on NES Map",
        outage_use_location: "Use My Location",
        outage_locating: "Locating...",
        outage_location_found: "Location found",
        outage_location_denied: "Location access denied",
        outage_location_error: "Could not get location",
        outage_location_unavailable: "Location not available",
        outage_fetch_error: "Failed to load outages",
        map_outage_map: "Outage Map",
        map_fullscreen: "Full Screen",
        map_legend_title: "Map Key",
        map_legend_waiting: "Waiting for crew",
        map_legend_assigned: "Crew assigned",
        map_legend_working: "Being repaired",
        map_legend_warming: "Warming center",
        map_stat_affected: "Affected",
        map_stat_crews: "Crews",
        map_stat_waiting: "Waiting",
        map_nes_website: "NES Website",
        map_report_outage: "Report Outage",
        map_popup_customers: "customers affected",
        map_popup_status: "Status",
        map_warming_open: "Open warming center",
        map_warming_unconfirmed: "Unconfirmed - verify status",
        map_warming_food: "Food available 24/7",
        map_warming_verify_link: "Verify on Nashville.gov",
        shelter_alert_date: "January 30, 2026 Update",
        shelter_alert_title: "Metro Emergency Overflow Shelter",
        shelter_alert_status: "Open 24 Hours",
        shelter_alert_location: "3230 Brick Church Pike, Nashville",
        shelter_alert_who: "Adults 18+, couples, pets welcome (kennels provided)",
        shelter_alert_services: "Hot meals, snacks, mats/cots, showers",
        shelter_alert_transport: "Free WeGo Bus Line #23B from WeGo Central after 7pm",
        shelter_alert_text: "Text OHSALERT to 888-777",
        shelter_alert_more: "Official Info",
        shelter_alert_note: "Primary shelters: Room In The Inn, Nashville Rescue Mission, Launch Pad, Oasis. Try primary shelters first."
      },
      es: {
        title: "Recursos de Invierno en Nashville",
        subtitle: "Refugio, comida y apoyo durante clima extremo",
        emergency_911: "Ubicación 911",
        start: "Empiece Aquí",
        wttin: "Dónde Acudir en Nashville",
        official: "Centros de Recursos Oficiales",
        nashville_weather: "Actualizaciones del Clima Invernal",
        ohs_extreme: "OHS – Clima Extremo",
        shelter_list: "Lista de Refugios de Metro",
        tema_map: "Mapa de Refugios de Tennessee",
        tema_hub: "Centro de Clima Invernal TEMA",
        fema: "FEMA Tormenta de Invierno 2026",
        shelter: "Refugio y Alcance",
        food: "Comida",
        second_harvest: "Banco de Alimentos Second Harvest",
        find_food: "Second Harvest – Encontrar Comida",
        dream_streets: "Dream Streets Comida Móvil",
        immigrant: "Comunidad Inmigrante",
        legal: "Recursos Legales y Otros",
        legal_aid: "Sociedad de Ayuda Legal de Middle TN",
        npt: "Recursos NPT para Personas sin Hogar",
        footer: "Comparte · Actualizado Ene 2026",
        forecast: "Pronóstico de 5 Días",
        update_btn: "Ir",
        loading_forecast: "Cargando pronóstico...",
        invalid_zip: "Por favor ingrese un código postal válido de 5 dígitos",
        forecast_error: "No se pudo obtener el pronóstico. Verifique el código postal.",
        weather_unknown: "Desconocido",
        day_sun: "Dom", day_mon: "Lun", day_tue: "Mar", day_wed: "Mié", day_thu: "Jue", day_fri: "Vie", day_sat: "Sáb",
        month_jan: "Ene", month_feb: "Feb", month_mar: "Mar", month_apr: "Abr", month_may: "May", month_jun: "Jun",
        month_jul: "Jul", month_aug: "Ago", month_sep: "Sep", month_oct: "Oct", month_nov: "Nov", month_dec: "Dic",
        weather_0: "Cielo Despejado", weather_1: "Mayormente Despejado", weather_2: "Parcialmente Nublado", weather_3: "Nublado",
        weather_45: "Neblina", weather_48: "Niebla Helada",
        weather_51: "Llovizna Ligera", weather_53: "Llovizna Moderada", weather_55: "Llovizna Densa",
        weather_56: "Llovizna Helada", weather_57: "Llovizna Helada Fuerte",
        weather_61: "Lluvia Ligera", weather_63: "Lluvia Moderada", weather_65: "Lluvia Fuerte",
        weather_66: "Lluvia Helada", weather_67: "Lluvia Helada Fuerte",
        weather_71: "Nieve Ligera", weather_73: "Nieve Moderada", weather_75: "Nieve Fuerte", weather_77: "Granos de Nieve",
        weather_80: "Chubascos Ligeros", weather_81: "Chubascos Moderados", weather_82: "Chubascos Violentos",
        weather_85: "Chubascos de Nieve Ligeros", weather_86: "Chubascos de Nieve Fuertes",
        weather_95: "Tormenta Eléctrica", weather_96: "Tormenta con Granizo", weather_99: "Tormenta Severa",
        weather_alerts: "Alertas Meteorológicas",
        loading_alerts: "Buscando alertas...",
        no_alerts: "No hay alertas meteorológicas activas para esta área",
        alert_effective: "Efectiva",
        alert_expires: "Expira",
        alert_show_details: "Mostrar Detalles",
        alert_hide_details: "Ocultar Detalles",
        severity_extreme: "Extrema",
        severity_severe: "Severa",
        severity_moderate: "Moderada",
        severity_minor: "Menor",
        severity_unknown: "Desconocida",
        get_location_911: "Obtener Mi Ubicación para 911",
        outreach_label: "Línea de Ayuda para Personas sin Hogar",
        power_outages: "Cortes de Energía",
        loading_outages: "Verificando cortes de NES...",
        no_outages: "No hay cortes de energía activos reportados",
        outage_customers: "Clientes afectados",
        outage_started: "Inicio",
        outage_cause: "Causa",
        outage_assigned: "Equipo Asignado",
        outage_unassigned: "Esperando Equipo",
        outage_view_map: "Ver Mapa NES",
        outages_total: "Total de cortes",
        outages_customers: "clientes afectados",
        outages_nearby: "cerca de ti",
        outages_near_you: "Cerca de Ti",
        outages_other_areas: "Otras Áreas",
        outages_more_nearby: "más cercanos",
        outage_miles: "mi",
        outage_nearby: "Cercano",
        outage_view_all: "Ver todos",
        outages_on_map: "cortes en el Mapa NES",
        outage_use_location: "Usar Mi Ubicación",
        outage_locating: "Localizando...",
        outage_location_found: "Ubicación encontrada",
        outage_location_denied: "Acceso a ubicación denegado",
        outage_location_error: "No se pudo obtener ubicación",
        outage_location_unavailable: "Ubicación no disponible",
        outage_fetch_error: "Error al cargar cortes",
        map_outage_map: "Mapa de Cortes",
        map_fullscreen: "Pantalla Completa",
        map_legend_title: "Leyenda",
        map_legend_waiting: "Esperando equipo",
        map_legend_assigned: "Equipo asignado",
        map_legend_working: "Reparando",
        map_legend_warming: "Centro de calentamiento",
        map_stat_affected: "Afectados",
        map_stat_crews: "Equipos",
        map_stat_waiting: "Esperando",
        map_nes_website: "Sitio Web NES",
        map_report_outage: "Reportar Corte",
        map_popup_customers: "clientes afectados",
        map_popup_status: "Estado",
        map_warming_open: "Centro de calentamiento abierto",
        map_warming_unconfirmed: "Sin confirmar - verificar estado",
        map_warming_food: "Comida disponible 24/7",
        map_warming_verify_link: "Verificar en Nashville.gov",
        shelter_alert_date: "Actualización 30 de enero de 2026",
        shelter_alert_title: "Refugio de Desbordamiento de Emergencia de Metro",
        shelter_alert_status: "Abierto 24 Horas",
        shelter_alert_location: "3230 Brick Church Pike, Nashville",
        shelter_alert_who: "Adultos 18+, parejas, mascotas bienvenidas (jaulas disponibles)",
        shelter_alert_services: "Comidas calientes, snacks, colchonetas/catres, duchas",
        shelter_alert_transport: "Autobús WeGo Línea #23B gratis desde WeGo Central después de las 7pm",
        shelter_alert_text: "Envía OHSALERT al 888-777",
        shelter_alert_more: "Información Oficial",
        shelter_alert_note: "Refugios principales: Room In The Inn, Nashville Rescue Mission, Launch Pad, Oasis. Pruebe primero los refugios principales."
      },
      ar: {
        title: "موارد الشتاء في ناشفيل",
        subtitle: "مأوى وطعام ودعم أثناء الطقس القاسي",
        emergency_911: "موقع 911",
        start: "ابدأ هنا",
        wttin: "أين تتوجه في ناشفيل",
        official: "مراكز الموارد الرسمية",
        nashville_weather: "تحديثات طقس الشتاء",
        ohs_extreme: "خدمات الطقس القاسي",
        shelter_list: "قائمة الملاجئ",
        tema_map: "خريطة ملاجئ تينيسي",
        tema_hub: "مركز طقس الشتاء TEMA",
        fema: "FEMA عاصفة الشتاء 2026",
        shelter: "المأوى والتواصل",
        food: "الطعام",
        second_harvest: "بنك الطعام Second Harvest",
        find_food: "Second Harvest – ابحث عن طعام",
        dream_streets: "Dream Streets طعام متنقل",
        immigrant: "مجتمع المهاجرين",
        legal: "الموارد القانونية وغيرها",
        legal_aid: "جمعية المساعدة القانونية",
        npt: "موارد NPT للمشردين",
        footer: "شارك على نطاق واسع · محدث يناير 2026",
        forecast: "توقعات 5 أيام",
        update_btn: "ابحث",
        loading_forecast: "جارٍ تحميل التوقعات...",
        invalid_zip: "يرجى إدخال رمز بريدي مكون من 5 أرقام",
        forecast_error: "تعذر الحصول على التوقعات. يرجى التحقق من الرمز البريدي.",
        weather_unknown: "غير معروف",
        day_sun: "أحد", day_mon: "إثنين", day_tue: "ثلاثاء", day_wed: "أربعاء", day_thu: "خميس", day_fri: "جمعة", day_sat: "سبت",
        month_jan: "يناير", month_feb: "فبراير", month_mar: "مارس", month_apr: "أبريل", month_may: "مايو", month_jun: "يونيو",
        month_jul: "يوليو", month_aug: "أغسطس", month_sep: "سبتمبر", month_oct: "أكتوبر", month_nov: "نوفمبر", month_dec: "ديسمبر",
        weather_0: "سماء صافية", weather_1: "صافٍ غالباً", weather_2: "غائم جزئياً", weather_3: "غائم",
        weather_45: "ضبابي", weather_48: "ضباب متجمد",
        weather_51: "رذاذ خفيف", weather_53: "رذاذ معتدل", weather_55: "رذاذ كثيف",
        weather_56: "رذاذ متجمد", weather_57: "رذاذ متجمد كثيف",
        weather_61: "مطر خفيف", weather_63: "مطر معتدل", weather_65: "مطر غزير",
        weather_66: "مطر متجمد", weather_67: "مطر متجمد غزير",
        weather_71: "ثلج خفيف", weather_73: "ثلج معتدل", weather_75: "ثلج كثيف", weather_77: "حبيبات ثلجية",
        weather_80: "زخات خفيفة", weather_81: "زخات معتدلة", weather_82: "زخات عنيفة",
        weather_85: "زخات ثلجية خفيفة", weather_86: "زخات ثلجية كثيفة",
        weather_95: "عاصفة رعدية", weather_96: "عاصفة رعدية مع برد", weather_99: "عاصفة رعدية شديدة",
        weather_alerts: "تنبيهات الطقس",
        loading_alerts: "جارٍ البحث عن تنبيهات...",
        no_alerts: "لا توجد تنبيهات طقس نشطة لهذه المنطقة",
        alert_effective: "ساري من",
        alert_expires: "ينتهي",
        alert_show_details: "عرض التفاصيل",
        alert_hide_details: "إخفاء التفاصيل",
        severity_extreme: "قصوى",
        severity_severe: "شديدة",
        severity_moderate: "متوسطة",
        severity_minor: "طفيفة",
        severity_unknown: "غير معروفة",
        get_location_911: "الحصول على موقعي لـ 911",
        outreach_label: "خط مساعدة المشردين",
        power_outages: "انقطاع الكهرباء",
        loading_outages: "جارٍ التحقق من انقطاعات NES...",
        no_outages: "لا توجد انقطاعات كهرباء نشطة",
        outage_customers: "العملاء المتأثرون",
        outage_started: "بدأ",
        outage_cause: "السبب",
        outage_assigned: "تم تعيين طاقم",
        outage_unassigned: "في انتظار الطاقم",
        outage_view_map: "عرض خريطة NES",
        outages_total: "إجمالي الانقطاعات",
        outages_customers: "عملاء متأثرون",
        outages_nearby: "بالقرب منك",
        outages_near_you: "بالقرب منك",
        outages_other_areas: "مناطق أخرى",
        outages_more_nearby: "أكثر قريبة",
        outage_miles: "ميل",
        outage_nearby: "قريب",
        outage_view_all: "عرض الكل",
        outages_on_map: "انقطاعات على خريطة NES",
        outage_use_location: "استخدم موقعي",
        outage_locating: "جارٍ تحديد الموقع...",
        outage_location_found: "تم العثور على الموقع",
        outage_location_denied: "تم رفض الوصول للموقع",
        outage_location_error: "تعذر الحصول على الموقع",
        outage_location_unavailable: "الموقع غير متاح",
        outage_fetch_error: "فشل في تحميل الانقطاعات",
        map_outage_map: "خريطة الانقطاعات",
        map_fullscreen: "ملء الشاشة",
        map_legend_title: "دليل الخريطة",
        map_legend_waiting: "في انتظار فريق",
        map_legend_assigned: "تم تعيين فريق",
        map_legend_working: "جاري الإصلاح",
        map_legend_warming: "مركز تدفئة",
        map_stat_affected: "متأثرون",
        map_stat_crews: "فرق",
        map_stat_waiting: "انتظار",
        map_nes_website: "موقع NES",
        map_report_outage: "إبلاغ عن انقطاع",
        map_popup_customers: "عملاء متأثرين",
        map_popup_status: "الحالة",
        map_warming_open: "مركز تدفئة مفتوح",
        map_warming_unconfirmed: "غير مؤكد - تحقق من الحالة",
        map_warming_food: "طعام متاح 24/7",
        map_warming_verify_link: "تحقق على Nashville.gov",
        shelter_alert_date: "تحديث 30 يناير 2026",
        shelter_alert_title: "مأوى الطوارئ الفائض في مترو",
        shelter_alert_status: "مفتوح 24 ساعة",
        shelter_alert_location: "3230 Brick Church Pike، ناشفيل",
        shelter_alert_who: "البالغون 18+، الأزواج، الحيوانات الأليفة مرحب بها (توفر أقفاص)",
        shelter_alert_services: "وجبات ساخنة، وجبات خفيفة، حصائر/أسرة، حمامات",
        shelter_alert_transport: "حافلة WeGo المجانية خط #23B من WeGo Central بعد 7 مساءً",
        shelter_alert_text: "أرسل OHSALERT إلى 888-777",
        shelter_alert_more: "معلومات رسمية",
        shelter_alert_note: "الملاجئ الرئيسية: Room In The Inn، Nashville Rescue Mission، Launch Pad، Oasis. جرب الملاجئ الرئيسية أولاً."
      },
      ku: {
        title: "سەرچاوەکانی زستانی ناشڤیل",
        subtitle: "پەناگا، خواردن و پشتیوانی لە کاتی کەشوهەوای سەخت",
        emergency_911: "شوێنی 911",
        start: "لێرەوە دەست پێبکە",
        wttin: "لە ناشڤیل بۆ کوێ بڕۆیت",
        official: "ناوەندە فەرمییەکانی سەرچاوە",
        nashville_weather: "نوێکردنەوەکانی کەشوهەوای زستان",
        ohs_extreme: "خزمەتگوزارییەکانی کەشوهەوای سەخت",
        shelter_list: "لیستی پەناگاکان",
        tema_map: "نەخشەی پەناگاکانی تێنێسی",
        tema_hub: "ناوەندی کەشوهەوای زستانی TEMA",
        fema: "زریانی زستانی FEMA 2026",
        shelter: "پەناگا و دەستڕاگەیشتن",
        food: "خواردن",
        second_harvest: "بانکی خواردنی Second Harvest",
        find_food: "Second Harvest – خواردن بدۆزەرەوە",
        dream_streets: "خواردنی گەڕۆکی Dream Streets",
        immigrant: "کۆمەڵگای کۆچبەران",
        legal: "سەرچاوە یاساییەکان و هیتر",
        legal_aid: "کۆمەڵەی یارمەتی یاسایی",
        npt: "سەرچاوەکانی NPT بۆ بێماڵان",
        footer: "بڵاوی بکەرەوە · نوێکراوەتەوە کانوونی دووەم 2026",
        forecast: "پێشبینی 5 ڕۆژ",
        update_btn: "بڕۆ",
        loading_forecast: "پێشبینی بارکردن...",
        invalid_zip: "تکایە کۆدی پۆستی 5 ژمارەیی دروست بنووسە",
        forecast_error: "نەتوانرا پێشبینی بهێنرێت. تکایە کۆدی پۆستی بپشکنە.",
        weather_unknown: "نەزانراو",
        day_sun: "یەکشەم", day_mon: "دووشەم", day_tue: "سێشەم", day_wed: "چوارشەم", day_thu: "پێنجشەم", day_fri: "هەینی", day_sat: "شەمە",
        month_jan: "کانوونی دووەم", month_feb: "شوبات", month_mar: "ئازار", month_apr: "نیسان", month_may: "ئایار", month_jun: "حوزەیران",
        month_jul: "تەمموز", month_aug: "ئاب", month_sep: "ئەیلول", month_oct: "تشرینی یەکەم", month_nov: "تشرینی دووەم", month_dec: "کانوونی یەکەم",
        weather_0: "ئاسمانی ڕوون", weather_1: "زۆربەی ڕوون", weather_2: "هەور کەمێک", weather_3: "هەورین",
        weather_45: "تەم", weather_48: "تەمی ساردبووەوە",
        weather_51: "نمنمی سووک", weather_53: "نمنمی مامناوەند", weather_55: "نمنمی قورس",
        weather_56: "نمنمی ساردبووەوە", weather_57: "نمنمی ساردبووەوەی قورس",
        weather_61: "باران سووک", weather_63: "باران مامناوەند", weather_65: "باران قورس",
        weather_66: "باران ساردبووەوە", weather_67: "باران ساردبووەوەی قورس",
        weather_71: "بەفر سووک", weather_73: "بەفر مامناوەند", weather_75: "بەفر قورس", weather_77: "دەنکە بەفر",
        weather_80: "شەپۆلی سووک", weather_81: "شەپۆلی مامناوەند", weather_82: "شەپۆلی توند",
        weather_85: "شەپۆلی بەفری سووک", weather_86: "شەپۆلی بەفری قورس",
        weather_95: "بروسکە", weather_96: "بروسکە لەگەڵ تەرزە", weather_99: "بروسکەی توند",
        weather_alerts: "ئاگاداریی کەشوهەوا",
        loading_alerts: "گەڕان بۆ ئاگاداریی...",
        no_alerts: "هیچ ئاگاداریی کەشوهەوای چالاک نییە بۆ ئەم ناوچەیە",
        alert_effective: "کاریگەر لە",
        alert_expires: "کۆتایی دێت",
        alert_show_details: "وردەکاری پیشانبدە",
        alert_hide_details: "وردەکاری بشارەوە",
        severity_extreme: "زۆر توند",
        severity_severe: "توند",
        severity_moderate: "مامناوەند",
        severity_minor: "سووک",
        severity_unknown: "نەزانراو",
        get_location_911: "شوێنەکەم بۆ 911 وەربگرە",
        outreach_label: "هێڵی یارمەتی بێماڵان",
        power_outages: "پچڕانی کارەبا",
        loading_outages: "پشکنینی پچڕانەکانی NES...",
        no_outages: "هیچ پچڕانی کارەبایەکی چالاک نییە",
        outage_customers: "کڕیارە کاریگەرەکان",
        outage_started: "دەستیپێکرد",
        outage_cause: "هۆکار",
        outage_assigned: "تیم دیاریکرا",
        outage_unassigned: "چاوەڕێی تیم",
        outage_view_map: "نەخشەی NES ببینە",
        outages_total: "کۆی پچڕانەکان",
        outages_customers: "کڕیاری کاریگەر",
        outages_nearby: "لە نزیکت",
        outages_near_you: "لە نزیکت",
        outages_other_areas: "ناوچەکانی تر",
        outages_more_nearby: "زیاتر لە نزیک",
        outage_miles: "میل",
        outage_nearby: "نزیک",
        outage_view_all: "هەموو ببینە",
        outages_on_map: "پچڕان لە نەخشەی NES",
        outage_use_location: "شوێنەکەم بەکاربهێنە",
        outage_locating: "گەڕان بۆ شوێن...",
        outage_location_found: "شوێن دۆزرایەوە",
        outage_location_denied: "ڕێگە نەدرا بۆ شوێن",
        outage_location_error: "نەتوانرا شوێن بدۆزرێتەوە",
        outage_location_unavailable: "شوێن بەردەست نییە",
        outage_fetch_error: "شکست هێنا لە بارکردنی پچڕانەکان",
        map_outage_map: "نەخشەی پچڕان",
        map_fullscreen: "ڕووپۆشی تەواو",
        map_legend_title: "ڕێنمایی نەخشە",
        map_legend_waiting: "چاوەڕوانی تیم",
        map_legend_assigned: "تیم دیاریکراوە",
        map_legend_working: "چاککردنەوە دەکرێت",
        map_legend_warming: "ناوەندی گەرمکردنەوە",
        map_stat_affected: "کاریگەر",
        map_stat_crews: "تیمەکان",
        map_stat_waiting: "چاوەڕوان",
        map_nes_website: "وێبسایتی NES",
        map_report_outage: "ڕاپۆرتی پچڕان",
        map_popup_customers: "کڕیاری کاریگەر",
        map_popup_status: "دۆخ",
        map_warming_open: "ناوەندی گەرمکردنەوە کراوەیە",
        map_warming_unconfirmed: "نەدڵنیا - دۆخەکە پشتڕاست بکەرەوە",
        map_warming_food: "خواردن بەردەستە 24/7",
        map_warming_verify_link: "پشتڕاستکردنەوە لە Nashville.gov",
        shelter_alert_date: "نوێکردنەوەی 30ی کانوونی دووەم 2026",
        shelter_alert_title: "پەناگای کاتی فریاکەوتنی میترۆ",
        shelter_alert_status: "24 کاتژمێر کراوەیە",
        shelter_alert_location: "3230 Brick Church Pike، ناشڤیل",
        shelter_alert_who: "بەساڵاچووان 18+، هاوسەران، ئاژەڵی ماڵی بەخێرهاتوون (قەفەس هەیە)",
        shelter_alert_services: "نانی گەرم، خواردنەوە، دۆشەک/تەخت، حەمام",
        shelter_alert_transport: "پاسی بەخۆڕایی WeGo هێڵی #23B لە WeGo Central پاش 7ی ئێوارە",
        shelter_alert_text: "OHSALERT بنێرە بۆ 888-777",
        shelter_alert_more: "زانیاری فەرمی",
        shelter_alert_note: "پەناگا سەرەکییەکان: Room In The Inn، Nashville Rescue Mission، Launch Pad، Oasis. سەرەتا پەناگا سەرەکییەکان تاقی بکەرەوە."
      },
      vi: {
        title: "Tài Nguyên Mùa Đông Nashville",
        subtitle: "Nơi trú ẩn, thực phẩm & hỗ trợ trong thời tiết khắc nghiệt",
        emergency_911: "Vị Trí 911",
        start: "Bắt Đầu Tại Đây",
        wttin: "Nơi Hướng Dẫn Tại Nashville",
        official: "Trung Tâm Tài Nguyên Chính Thức",
        nashville_weather: "Cập Nhật Thời Tiết Mùa Đông",
        ohs_extreme: "OHS – Thời Tiết Khắc Nghiệt",
        shelter_list: "Danh Sách Nơi Trú Ẩn Metro",
        tema_map: "Bản Đồ Nơi Trú Ẩn Toàn Tiểu Bang",
        tema_hub: "Trung Tâm Thời Tiết Mùa Đông TEMA",
        fema: "FEMA Bão Tuyết 2026",
        shelter: "Nơi Trú Ẩn & Tiếp Cận",
        food: "Thực Phẩm",
        second_harvest: "Ngân Hàng Thực Phẩm Second Harvest",
        find_food: "Second Harvest – Tìm Thực Phẩm",
        dream_streets: "Dream Streets Thực Phẩm Di Động",
        immigrant: "Cộng Đồng Người Nhập Cư",
        legal: "Tài Nguyên Pháp Lý & Khác",
        legal_aid: "Hội Trợ Giúp Pháp Lý Middle TN",
        npt: "Tài Nguyên NPT cho Người Vô Gia Cư",
        footer: "Chia sẻ rộng rãi · Cập nhật Tháng 1 2026",
        forecast: "Dự Báo 5 Ngày",
        update_btn: "Tìm",
        loading_forecast: "Đang tải dự báo...",
        invalid_zip: "Vui lòng nhập mã ZIP gồm 5 chữ số",
        forecast_error: "Không thể tải dự báo. Vui lòng kiểm tra mã ZIP.",
        weather_unknown: "Không rõ",
        day_sun: "CN", day_mon: "T2", day_tue: "T3", day_wed: "T4", day_thu: "T5", day_fri: "T6", day_sat: "T7",
        month_jan: "Th1", month_feb: "Th2", month_mar: "Th3", month_apr: "Th4", month_may: "Th5", month_jun: "Th6",
        month_jul: "Th7", month_aug: "Th8", month_sep: "Th9", month_oct: "Th10", month_nov: "Th11", month_dec: "Th12",
        weather_0: "Trời Quang", weather_1: "Phần Lớn Quang", weather_2: "Có Mây Rải Rác", weather_3: "U Ám",
        weather_45: "Sương Mù", weather_48: "Sương Muối",
        weather_51: "Mưa Phùn Nhẹ", weather_53: "Mưa Phùn Vừa", weather_55: "Mưa Phùn Dày",
        weather_56: "Mưa Phùn Đóng Băng", weather_57: "Mưa Phùn Đóng Băng Nặng",
        weather_61: "Mưa Nhẹ", weather_63: "Mưa Vừa", weather_65: "Mưa To",
        weather_66: "Mưa Đóng Băng", weather_67: "Mưa Đóng Băng Nặng",
        weather_71: "Tuyết Nhẹ", weather_73: "Tuyết Vừa", weather_75: "Tuyết Dày", weather_77: "Hạt Tuyết",
        weather_80: "Mưa Rào Nhẹ", weather_81: "Mưa Rào Vừa", weather_82: "Mưa Rào Dữ Dội",
        weather_85: "Tuyết Rơi Nhẹ", weather_86: "Tuyết Rơi Nặng",
        weather_95: "Giông Bão", weather_96: "Giông Bão Có Mưa Đá", weather_99: "Giông Bão Dữ Dội",
        weather_alerts: "Cảnh Báo Thời Tiết",
        loading_alerts: "Đang kiểm tra cảnh báo...",
        no_alerts: "Không có cảnh báo thời tiết nào cho khu vực này",
        alert_effective: "Có hiệu lực",
        alert_expires: "Hết hạn",
        alert_show_details: "Xem Chi Tiết",
        alert_hide_details: "Ẩn Chi Tiết",
        severity_extreme: "Cực Kỳ Nghiêm Trọng",
        severity_severe: "Nghiêm Trọng",
        severity_moderate: "Trung Bình",
        severity_minor: "Nhẹ",
        severity_unknown: "Không Rõ",
        get_location_911: "Lấy Vị Trí Của Tôi Cho 911",
        outreach_label: "Đường Dây Hỗ Trợ Người Vô Gia Cư",
        power_outages: "Mất Điện",
        loading_outages: "Đang kiểm tra tình trạng mất điện NES...",
        no_outages: "Không có báo cáo mất điện nào",
        outage_customers: "Khách hàng bị ảnh hưởng",
        outage_started: "Bắt đầu",
        outage_cause: "Nguyên nhân",
        outage_assigned: "Đã Có Đội Kỹ Thuật",
        outage_unassigned: "Đang Chờ Đội Kỹ Thuật",
        outage_view_map: "Xem Bản Đồ NES",
        outages_total: "Tổng số sự cố",
        outages_customers: "khách hàng bị ảnh hưởng",
        outages_nearby: "gần bạn",
        outages_near_you: "Gần Bạn",
        outages_other_areas: "Khu Vực Khác",
        outages_more_nearby: "gần hơn",
        outage_miles: "dặm",
        outage_nearby: "Gần Đây",
        outage_view_all: "Xem tất cả",
        outages_on_map: "sự cố trên Bản Đồ NES",
        outage_use_location: "Dùng Vị Trí Của Tôi",
        outage_locating: "Đang định vị...",
        outage_location_found: "Đã tìm thấy vị trí",
        outage_location_denied: "Quyền truy cập vị trí bị từ chối",
        outage_location_error: "Không thể lấy vị trí",
        outage_location_unavailable: "Vị trí không khả dụng",
        outage_fetch_error: "Không thể tải sự cố",
        map_outage_map: "Bản Đồ Mất Điện",
        map_fullscreen: "Toàn Màn Hình",
        map_legend_title: "Chú Thích",
        map_legend_waiting: "Đang chờ đội",
        map_legend_assigned: "Đã phân công đội",
        map_legend_working: "Đang sửa chữa",
        map_legend_warming: "Trung tâm sưởi ấm",
        map_stat_affected: "Bị ảnh hưởng",
        map_stat_crews: "Đội",
        map_stat_waiting: "Đang chờ",
        map_nes_website: "Trang Web NES",
        map_report_outage: "Báo Cáo Mất Điện",
        map_popup_customers: "khách hàng bị ảnh hưởng",
        map_popup_status: "Trạng thái",
        map_warming_open: "Trung tâm sưởi ấm đang mở",
        map_warming_unconfirmed: "Chưa xác nhận - kiểm tra trạng thái",
        map_warming_food: "Có thức ăn 24/7",
        map_warming_verify_link: "Xác minh tại Nashville.gov",
        shelter_alert_date: "Cập nhật ngày 30 tháng 1, 2026",
        shelter_alert_title: "Nơi Trú Ẩn Khẩn Cấp Tràn Lan Metro",
        shelter_alert_status: "Mở 24 Giờ",
        shelter_alert_location: "3230 Brick Church Pike, Nashville",
        shelter_alert_who: "Người lớn 18+, cặp đôi, thú cưng được chào đón (có chuồng)",
        shelter_alert_services: "Bữa ăn nóng, đồ ăn nhẹ, chiếu/giường gấp, nhà tắm",
        shelter_alert_transport: "Xe buýt WeGo miễn phí Tuyến #23B từ WeGo Central sau 7 giờ tối",
        shelter_alert_text: "Nhắn OHSALERT đến 888-777",
        shelter_alert_more: "Thông Tin Chính Thức",
        shelter_alert_note: "Nơi trú ẩn chính: Room In The Inn, Nashville Rescue Mission, Launch Pad, Oasis. Hãy thử các nơi trú ẩn chính trước."
      }
    };

    const rtlLangs = ['ar', 'ku'];

    const langCodes = {
      en: 'en',
      es: 'es',
      ar: 'ar',
      ku: 'ckb',
      vi: 'vi'
    };

    // Get language from URL parameter (?es, ?ar, etc.)
    function getLanguageFromURL() {
      // First check the current page's URL
      const search = window.location.search.slice(1).toLowerCase(); // Remove '?' and lowercase
      if (search && translations[search]) {
        return search;
      }
      // If embedded, also check the referrer URL (parent page) for language parameter
      if (document.referrer) {
        try {
          const referrerUrl = new URL(document.referrer);
          const referrerLang = referrerUrl.search.slice(1).toLowerCase();
          if (referrerLang && translations[referrerLang]) {
            return referrerLang;
          }
        } catch (e) {
          // Invalid referrer URL, ignore
        }
      }
      return null;
    }

    // Update URL with current language without adding history entry
    function updateURLWithLanguage(lang) {
      const url = new URL(window.location);
      url.search = (lang === 'en') ? '' : `?${lang}`;
      window.history.replaceState({}, '', url);
    }

    // Update internal navigation links to preserve language
    function updateInternalLinks(lang) {
      document.querySelectorAll('.location-btn, .back-link').forEach(link => {
        const baseUrl = link.getAttribute('href').split('?')[0];
        link.href = (lang === 'en') ? baseUrl : `${baseUrl}?${lang}`;
      });
    }

    function updateExternalLinks(lang) {
      document.querySelectorAll('.external-link').forEach(link => {
        const originalUrl = link.dataset.href;
        if (lang === 'en') {
          link.href = originalUrl;
        } else {
          link.href = `https://translate.google.com/translate?sl=en&tl=${langCodes[lang]}&u=${encodeURIComponent(originalUrl)}`;
        }
      });
    }

    function setLanguage(lang) {
      document.querySelectorAll('.lang-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.lang === lang);
      });

      if (rtlLangs.includes(lang)) {
        document.documentElement.setAttribute('dir', 'rtl');
        document.documentElement.setAttribute('lang', lang);
      } else {
        document.documentElement.setAttribute('dir', 'ltr');
        document.documentElement.setAttribute('lang', lang);
      }

      document.querySelectorAll('[data-i18n]').forEach(el => {
        const key = el.dataset.i18n;
        if (translations[lang][key]) {
          el.textContent = translations[lang][key];
        }
      });

      updateExternalLinks(lang);
      updateInternalLinks(lang);
      localStorage.setItem('nashville-resources-lang', lang);
      updateURLWithLanguage(lang);

      // Re-render weather data with new language
      if (cachedWeatherData) {
        renderForecast(cachedWeatherData);
      }
      if (cachedAlertsData) {
        renderAlerts(cachedAlertsData);
      }
      if (cachedOutagesData) {
        renderOutages(cachedOutagesData);
      }
    }

    document.querySelectorAll('.lang-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        trackActivity('language_change', { language: btn.dataset.lang });
        setLanguage(btn.dataset.lang);
      });
    });

    // Check URL parameter first, then localStorage
    const urlLang = getLanguageFromURL();
    const savedLang = localStorage.getItem('nashville-resources-lang');
    if (urlLang) {
      setLanguage(urlLang);
    } else if (savedLang && translations[savedLang]) {
      setLanguage(savedLang);
    }

    // Text size controls
    const textSizes = ['normal', 'large', 'xlarge'];
    let currentTextSizeIndex = 0;

    function setTextSize(size) {
      // Remove all size classes
      ['small', 'normal', 'large', 'xlarge'].forEach(s => document.documentElement.classList.remove(`text-${s}`));
      // Add the selected size class
      document.documentElement.classList.add(`text-${size}`);
      // Update toggle button state
      const toggle = document.getElementById('textSizeToggle');
      if (toggle) {
        toggle.classList.toggle('active', size !== 'normal');
      }
      // Save preference
      localStorage.setItem('nashville-resources-textsize', size);
    }

    // Text size toggle - cycles through sizes
    document.getElementById('textSizeToggle')?.addEventListener('click', () => {
      currentTextSizeIndex = (currentTextSizeIndex + 1) % textSizes.length;
      const newSize = textSizes[currentTextSizeIndex];
      trackActivity('text_size_change', { size: newSize });
      setTextSize(newSize);
    });

    // Load saved text size
    const savedTextSize = localStorage.getItem('nashville-resources-textsize');
    if (savedTextSize && textSizes.includes(savedTextSize)) {
      currentTextSizeIndex = textSizes.indexOf(savedTextSize);
      setTextSize(savedTextSize);
    }

    // Weather Forecast Functionality
    const weatherIcons = {
      0: 'ph-sun', 1: 'ph-sun', 2: 'ph-cloud-sun', 3: 'ph-cloud',
      45: 'ph-cloud-fog', 48: 'ph-cloud-fog',
      51: 'ph-cloud-rain', 53: 'ph-cloud-rain', 55: 'ph-cloud-rain',
      56: 'ph-cloud-rain', 57: 'ph-cloud-rain',
      61: 'ph-cloud-rain', 63: 'ph-cloud-rain', 65: 'ph-cloud-rain',
      66: 'ph-cloud-rain', 67: 'ph-cloud-rain',
      71: 'ph-snowflake', 73: 'ph-snowflake', 75: 'ph-snowflake', 77: 'ph-snowflake',
      80: 'ph-cloud-rain', 81: 'ph-cloud-rain', 82: 'ph-cloud-rain',
      85: 'ph-snowflake', 86: 'ph-snowflake',
      95: 'ph-cloud-lightning', 96: 'ph-cloud-lightning', 99: 'ph-cloud-lightning'
    };

    function getCurrentLang() {
      return localStorage.getItem('nashville-resources-lang') || 'en';
    }

    function t(key) {
      const lang = getCurrentLang();
      return translations[lang][key] || translations['en'][key] || key;
    }

    function getDayName(dayIndex) {
      const keys = ['day_sun', 'day_mon', 'day_tue', 'day_wed', 'day_thu', 'day_fri', 'day_sat'];
      return t(keys[dayIndex]);
    }

    function getMonthName(monthIndex) {
      const keys = ['month_jan', 'month_feb', 'month_mar', 'month_apr', 'month_may', 'month_jun',
                    'month_jul', 'month_aug', 'month_sep', 'month_oct', 'month_nov', 'month_dec'];
      return t(keys[monthIndex]);
    }

    function getWeatherLabel(code) {
      return t('weather_' + code) || t('weather_unknown');
    }

    async function getCoordinates(zip) {
      const response = await fetch(`https://nominatim.openstreetmap.org/search?postalcode=${zip}&country=US&format=json&limit=1`);
      const data = await response.json();
      if (data.length === 0) throw new Error('Location not found');
      return {
        lat: parseFloat(data[0].lat),
        lon: parseFloat(data[0].lon),
        name: data[0].display_name.split(',').slice(0, 2).join(',').trim()
      };
    }

    async function getWeather(lat, lon) {
      const response = await fetch(
        `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&daily=weather_code,temperature_2m_max,temperature_2m_min&temperature_unit=fahrenheit&timezone=auto&forecast_days=5`
      );
      return response.json();
    }

    async function getNWSAlerts(lat, lon) {
      try {
        const response = await fetch(
          `https://api.weather.gov/alerts/active?point=${lat.toFixed(4)},${lon.toFixed(4)}`,
          {
            headers: {
              'User-Agent': '(NashvilleEmergencyResources, contact@example.com)',
              'Accept': 'application/geo+json'
            }
          }
        );
        if (!response.ok) throw new Error('NWS API error');
        const data = await response.json();
        return data.features || [];
      } catch (err) {
        console.error('Failed to fetch NWS alerts:', err);
        return [];
      }
    }

    // Haversine distance calculation (returns miles)
    function calculateDistance(lat1, lon1, lat2, lon2) {
      const R = 3959; // Earth's radius in miles
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLon = (lon2 - lon1) * Math.PI / 180;
      const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLon/2) * Math.sin(dLon/2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return R * c;
    }

    // NES Power Outage API - data source: github.com/NeckBeardPrince/nes-outage-status-checker
    async function getNESOutages(userLat, userLon) {
      try {
        const response = await fetch(
          'https://utilisocial.io/datacapable/v2/p/NES/map/events',
          {
            headers: {
              'Accept': 'application/json'
            }
          }
        );
        if (!response.ok) throw new Error('NES API error');
        const data = await response.json();

        if (!data || data.length === 0) return { all: [], nearby: [] };

        // Calculate distance for each outage and categorize
        const NEARBY_RADIUS = 15; // miles
        const outagesWithDistance = data.map(outage => {
          // Try different possible coordinate field names
          const lat = outage.lat || outage.latitude || outage.location?.lat || outage.location?.latitude;
          const lon = outage.lon || outage.lng || outage.longitude || outage.location?.lon || outage.location?.lng || outage.location?.longitude;

          let distance = null;
          if (lat && lon && userLat && userLon) {
            distance = calculateDistance(userLat, userLon, lat, lon);
          }
          return { ...outage, distance };
        });

        // Separate nearby and all outages
        const nearby = outagesWithDistance
          .filter(o => o.distance !== null && o.distance <= NEARBY_RADIUS)
          .sort((a, b) => a.distance - b.distance);

        const all = outagesWithDistance.sort((a, b) => (b.numPeople || 0) - (a.numPeople || 0));

        return { all, nearby, userCoords: { lat: userLat, lon: userLon } };
      } catch (err) {
        console.error('Failed to fetch NES outages:', err);
        return { all: [], nearby: [] };
      }
    }

    function getSeverityClass(severity) {
      const s = (severity || '').toLowerCase();
      if (s === 'extreme') return 'severity-extreme';
      if (s === 'severe') return 'severity-severe';
      if (s === 'moderate') return 'severity-moderate';
      if (s === 'minor') return 'severity-minor';
      return 'severity-unknown';
    }

    function getSeverityIcon(severity) {
      const s = (severity || '').toLowerCase();
      if (s === 'extreme' || s === 'severe') return 'ph-warning-octagon';
      if (s === 'moderate') return 'ph-warning';
      return 'ph-info';
    }

    function getSeverityLabel(severity) {
      const s = (severity || '').toLowerCase();
      if (s === 'extreme') return t('severity_extreme');
      if (s === 'severe') return t('severity_severe');
      if (s === 'moderate') return t('severity_moderate');
      if (s === 'minor') return t('severity_minor');
      return t('severity_unknown');
    }

    function formatAlertTime(isoString) {
      if (!isoString) return '';
      const d = new Date(isoString);
      const dayName = getDayName(d.getDay());
      const monthName = getMonthName(d.getMonth());
      const day = d.getDate();
      const hours = d.getHours();
      const minutes = d.getMinutes().toString().padStart(2, '0');
      const ampm = hours >= 12 ? 'PM' : 'AM';
      const hour12 = hours % 12 || 12;
      return `${dayName}, ${monthName} ${day}, ${hour12}:${minutes} ${ampm}`;
    }

    async function renderAlerts(alerts) {
      const container = document.getElementById('alertsContainer');
      container.innerHTML = '';
      const lang = getCurrentLang();

      if (!alerts || alerts.length === 0) {
        container.innerHTML = `
          <div class="no-alerts">
            <i class="ph ph-check-circle"></i>
            <span data-i18n="no_alerts">${t('no_alerts')}</span>
          </div>
        `;
        return;
      }

      // Sort by severity (extreme first)
      const severityOrder = { extreme: 0, severe: 1, moderate: 2, minor: 3, unknown: 4 };
      alerts.sort((a, b) => {
        const sA = (a.properties.severity || 'unknown').toLowerCase();
        const sB = (b.properties.severity || 'unknown').toLowerCase();
        return (severityOrder[sA] ?? 4) - (severityOrder[sB] ?? 4);
      });

      for (let index = 0; index < alerts.length; index++) {
        const alert = alerts[index];
        const props = alert.properties;
        const severity = props.severity || 'Unknown';
        const event = props.event || 'Weather Alert';
        const headline = props.headline || event;
        const description = props.description || '';
        const effective = props.effective;
        const expires = props.expires;

        // Translate event name and headline
        const displayEvent = await translateText(event, lang);
        const displayHeadline = await translateText(headline, lang);

        const banner = document.createElement('div');
        banner.className = `alert-banner ${getSeverityClass(severity)}`;
        banner.style.animationDelay = `${index * 0.1}s`;

        banner.innerHTML = `
          <i class="ph ${getSeverityIcon(severity)} alert-icon"></i>
          <div class="alert-content">
            <div class="alert-header">
              <span class="alert-title">${displayEvent}</span>
              <span class="alert-severity-badge">${getSeverityLabel(severity)}</span>
            </div>
            <p class="alert-description" id="alert-desc-${index}">${displayHeadline}</p>
            ${description ? `<button class="alert-expand-btn" onclick="toggleAlertExpand(${index}, this)" data-i18n="alert_show_details">${t('alert_show_details')}</button>` : ''}
            <div class="alert-meta">
              ${effective ? `<span><i class="ph ph-clock"></i> ${t('alert_effective')}: ${formatAlertTime(effective)}</span>` : ''}
              ${expires ? `<span><i class="ph ph-clock-countdown"></i> ${t('alert_expires')}: ${formatAlertTime(expires)}</span>` : ''}
            </div>
          </div>
          <button class="alert-dismiss" onclick="this.parentElement.remove()" aria-label="Dismiss alert">
            <i class="ph ph-x"></i>
          </button>
        `;

        // Store original English for expansion and translation
        banner.dataset.fullDescription = description;
        banner.dataset.headline = displayHeadline;
        banner.dataset.originalDescription = description;

        container.appendChild(banner);
      }
    }

    function formatOutageTime(timestamp) {
      if (!timestamp) return '';
      const d = new Date(timestamp);
      const dayName = getDayName(d.getDay());
      const monthName = getMonthName(d.getMonth());
      const day = d.getDate();
      const hours = d.getHours();
      const minutes = d.getMinutes().toString().padStart(2, '0');
      const ampm = hours >= 12 ? 'PM' : 'AM';
      const hour12 = hours % 12 || 12;
      return `${dayName}, ${monthName} ${day}, ${hour12}:${minutes} ${ampm}`;
    }

    function renderOutages(outageData) {
      const container = document.getElementById('outagesContainer');
      container.innerHTML = '';

      // Handle both old format (array) and new format (object with nearby/all)
      const nearby = outageData?.nearby || [];
      const all = outageData?.all || (Array.isArray(outageData) ? outageData : []);

      if (all.length === 0) {
        container.innerHTML = `
          <div class="no-outages">
            <i class="ph ph-check-circle"></i>
            <span data-i18n="no_outages">${t('no_outages')}</span>
          </div>
        `;
        return;
      }

      // Calculate totals for summary
      const totalOutages = all.length;
      const totalCustomers = all.reduce((sum, o) => sum + (o.numPeople || 0), 0);

      // Show summary card
      const summary = document.createElement('div');
      summary.className = 'outages-summary';
      summary.innerHTML = `
        <div class="outages-summary-header">
          <div class="outages-summary-title">
            <i class="ph ph-lightning"></i>
            <span>NES ${t('power_outages')}</span>
          </div>
          <a href="https://nespower.com/outages" target="_blank" rel="noopener noreferrer" class="outages-summary-link">
            ${t('outage_view_map')} <i class="ph ph-arrow-square-out"></i>
          </a>
        </div>
        <div class="outages-summary-stats">
          <span><strong>${totalOutages}</strong> ${t('outages_total')}</span>
          <span><strong>${totalCustomers.toLocaleString()}</strong> ${t('outages_customers')}</span>
          ${nearby.length > 0 ? `<span><strong>${nearby.length}</strong> ${t('outages_nearby')}</span>` : ''}
        </div>
      `;
      container.appendChild(summary);

      // Helper to create outage banner
      function createOutageBanner(outage, index, isNearby) {
        // Use status field (consistent with map markers) - API returns status text like "Assigned", "Crew En Route", etc.
        const status = outage.status || outage.crewStatus || '';
        const statusCategory = getMapStatusCategory(status);
        const isAssigned = statusCategory === 'assigned' || statusCategory === 'working';
        const banner = document.createElement('div');
        banner.className = `outage-banner ${isAssigned ? 'assigned' : ''} ${isNearby ? 'nearby' : ''}`;
        banner.style.animationDelay = `${index * 0.1}s`;

        const startTime = outage.startTime ? formatOutageTime(outage.startTime) : '';
        const cause = outage.cause || 'Unknown';
        const numCustomers = outage.numPeople || 0;
        const distance = outage.distance;
        const distanceStr = distance !== null ? `${distance.toFixed(1)} ${t('outage_miles')}` : '';

        banner.innerHTML = `
          <i class="ph ph-lightning outage-icon ${isAssigned ? '' : 'unassigned'}"></i>
          <div class="outage-content">
            <div class="outage-header">
              <span class="outage-title">${t('power_outages')}</span>
              <span class="outage-status-badge">${isAssigned ? t('outage_assigned') : t('outage_unassigned')}</span>
              ${isNearby ? `<span class="outage-nearby-badge">${t('outage_nearby')}</span>` : ''}
            </div>
            <p class="outage-description">${t('outage_cause')}: ${cause}</p>
            <div class="outage-meta">
              <span><i class="ph ph-users"></i> ${numCustomers.toLocaleString()} ${t('outage_customers')}</span>
              ${distanceStr ? `<span><i class="ph ph-map-pin"></i> ${distanceStr}</span>` : ''}
              ${startTime ? `<span><i class="ph ph-clock"></i> ${t('outage_started')}: ${startTime}</span>` : ''}
            </div>
          </div>
          <button class="outage-dismiss" onclick="this.parentElement.remove()" aria-label="Dismiss outage">
            <i class="ph ph-x"></i>
          </button>
        `;

        return banner;
      }

      // Show nearby outages first (if any)
      if (nearby.length > 0) {
        const nearbyHeader = document.createElement('div');
        nearbyHeader.className = 'outage-section-header collapsed';
        nearbyHeader.innerHTML = `<i class="ph ph-map-pin"></i> ${t('outages_near_you')} (${nearby.length}) <i class="ph ph-caret-down toggle-icon"></i>`;
        container.appendChild(nearbyHeader);

        // Create collapsible container for nearby outages
        const nearbyContainer = document.createElement('div');
        nearbyContainer.className = 'outage-list-container collapsed';
        nearbyContainer.id = 'nearbyOutagesList';

        nearby.slice(0, 5).forEach((outage, index) => {
          nearbyContainer.appendChild(createOutageBanner(outage, index, true));
        });

        if (nearby.length > 5) {
          const moreNearby = document.createElement('div');
          moreNearby.className = 'outage-more-text';
          moreNearby.textContent = `+ ${nearby.length - 5} ${t('outages_more_nearby')}`;
          nearbyContainer.appendChild(moreNearby);
        }

        container.appendChild(nearbyContainer);

        // Add click handler to toggle collapse
        nearbyHeader.addEventListener('click', () => {
          nearbyHeader.classList.toggle('collapsed');
          nearbyContainer.classList.toggle('collapsed');
          if (!nearbyContainer.classList.contains('collapsed')) {
            nearbyContainer.style.maxHeight = nearbyContainer.scrollHeight + 'px';
          } else {
            nearbyContainer.style.maxHeight = '0';
          }
        });
      }

      // Show other outages (not nearby) if we have space
      const otherOutages = all.filter(o => !nearby.some(n => n === o || (n.id && n.id === o.id)));
      if (otherOutages.length > 0 && nearby.length < 5) {
        const showCount = Math.min(5 - nearby.length, otherOutages.length);

        if (nearby.length > 0) {
          const otherHeader = document.createElement('div');
          otherHeader.className = 'outage-section-header';
          otherHeader.innerHTML = `<i class="ph ph-lightning"></i> ${t('outages_other_areas')}`;
          container.appendChild(otherHeader);
        }

        otherOutages.slice(0, showCount).forEach((outage, index) => {
          container.appendChild(createOutageBanner(outage, index + nearby.length, false));
        });
      }

      // If there are more outages, show a link
      if (all.length > 5) {
        const moreLink = document.createElement('a');
        moreLink.href = 'https://nespower.com/outages';
        moreLink.target = '_blank';
        moreLink.rel = 'noopener noreferrer';
        moreLink.className = 'outage-link';
        moreLink.style.display = 'flex';
        moreLink.style.justifyContent = 'center';
        moreLink.style.marginTop = '0.5rem';
        moreLink.innerHTML = `<i class="ph ph-arrow-square-out"></i> ${t('outage_view_all')} ${all.length} ${t('outages_on_map')}`;
        container.appendChild(moreLink);
      }
    }

    // Use device location for outage search
    window.useMyLocationForOutages = async function() {
      const btn = document.getElementById('outageLocationBtn');
      const status = document.getElementById('outageLocationStatus');

      if (!navigator.geolocation) {
        status.className = 'outage-location-status error';
        status.innerHTML = `<i class="ph ph-warning"></i> ${t('outage_location_unavailable')}`;
        return;
      }

      btn.disabled = true;
      btn.innerHTML = `<i class="ph ph-spinner" style="animation: spin 1s linear infinite;"></i> ${t('outage_locating')}`;
      status.className = 'outage-location-status';
      status.innerHTML = '';

      document.getElementById('outagesContainer').innerHTML = `
        <div class="outages-loading">
          <i class="ph ph-lightning"></i>
          <span>${t('loading_outages')}</span>
        </div>
      `;

      navigator.geolocation.getCurrentPosition(
        async (position) => {
          const { latitude, longitude } = position.coords;

          try {
            const outages = await getNESOutages(latitude, longitude);
            cachedOutagesData = outages;
            renderOutages(outages);

            btn.disabled = false;
            btn.innerHTML = `<i class="ph ph-crosshair"></i> <span data-i18n="outage_use_location">${t('outage_use_location')}</span>`;
            status.className = 'outage-location-status success';
            status.innerHTML = `<i class="ph ph-check-circle"></i> ${t('outage_location_found')}`;

            trackActivity('outage_location_used', { method: 'gps' });
          } catch (err) {
            console.error('Failed to fetch outages with location:', err);
            btn.disabled = false;
            btn.innerHTML = `<i class="ph ph-crosshair"></i> <span data-i18n="outage_use_location">${t('outage_use_location')}</span>`;
            status.className = 'outage-location-status error';
            status.innerHTML = `<i class="ph ph-warning"></i> ${t('outage_fetch_error')}`;
          }
        },
        (error) => {
          console.error('Geolocation error:', error);
          btn.disabled = false;
          btn.innerHTML = `<i class="ph ph-crosshair"></i> <span data-i18n="outage_use_location">${t('outage_use_location')}</span>`;
          status.className = 'outage-location-status error';
          if (error.code === error.PERMISSION_DENIED) {
            status.innerHTML = `<i class="ph ph-warning"></i> ${t('outage_location_denied')}`;
          } else {
            status.innerHTML = `<i class="ph ph-warning"></i> ${t('outage_location_error')}`;
          }
        },
        { enableHighAccuracy: true, timeout: 10000, maximumAge: 60000 }
      );
    };

    window.toggleAlertExpand = async function(index, btn) {
      const desc = document.getElementById(`alert-desc-${index}`);
      const banner = btn.closest('.alert-banner');
      const originalDesc = banner.dataset.originalDescription;
      const headline = banner.dataset.headline;
      const lang = getCurrentLang();

      if (desc.classList.contains('expanded')) {
        desc.classList.remove('expanded');
        desc.textContent = headline;
        btn.textContent = t('alert_show_details');
        trackActivity('alert_collapse', { alertIndex: index });
      } else {
        desc.classList.add('expanded');
        // Show loading indicator
        btn.innerHTML = '<i class="ph ph-spinner" style="animation: spin 1s linear infinite;"></i>';
        // Translate description
        const displayDesc = await translateText(originalDesc, lang);
        desc.textContent = displayDesc;
        btn.textContent = t('alert_hide_details');
        trackActivity('alert_expand', { alertIndex: index, alertHeadline: headline });
      }
    };

    function renderForecast(weather) {
      const grid = document.getElementById('forecastGrid');
      grid.innerHTML = '';

      weather.daily.time.forEach((date, index) => {
        const d = new Date(date + 'T12:00:00');
        const code = weather.daily.weather_code[index];
        const icon = weatherIcons[code] || 'ph-question';
        const label = getWeatherLabel(code);
        const high = Math.round(weather.daily.temperature_2m_max[index]);
        const low = Math.round(weather.daily.temperature_2m_min[index]);

        const card = document.createElement('div');
        card.className = 'day-card';
        card.innerHTML = `
          <div class="day-name">${getDayName(d.getDay())}</div>
          <div class="day-date">${getMonthName(d.getMonth())} ${d.getDate()}</div>
          <i class="ph ${icon} weather-icon"></i>
          <div class="condition">${label}</div>
          <div class="temps">
            <div class="temp-high">
              <i class="ph ph-arrow-up"></i>
              <span>${high}°</span>
            </div>
            <div class="temp-low">
              <i class="ph ph-arrow-down"></i>
              <span>${low}°</span>
            </div>
          </div>
        `;
        grid.appendChild(card);
      });
    }

    function showForecastError(message) {
      document.getElementById('forecastGrid').innerHTML = `
        <div class="forecast-error">
          <i class="ph ph-warning-circle"></i>
          <p>${message}</p>
        </div>
      `;
    }

    async function fetchForecast() {
      const zip = document.getElementById('zipInput').value.trim();
      if (!/^\d{5}$/.test(zip)) {
        showForecastError(t('invalid_zip'));
        return;
      }

      document.getElementById('forecastGrid').innerHTML = `
        <div class="forecast-loading">
          <i class="ph ph-cloud"></i>
          <p>${t('loading_forecast')}</p>
        </div>
      `;

      document.getElementById('alertsContainer').innerHTML = `
        <div class="alerts-loading">
          <i class="ph ph-cloud"></i>
          <span>${t('loading_alerts')}</span>
        </div>
      `;

      document.getElementById('outagesContainer').innerHTML = `
        <div class="outages-loading">
          <i class="ph ph-lightning"></i>
          <span>${t('loading_outages')}</span>
        </div>
      `;

      try {
        const coords = await getCoordinates(zip);
        document.getElementById('locationDisplay').textContent = coords.name;

        // Fetch weather, NWS alerts, and NES outages in parallel
        const [weather, alerts, outages] = await Promise.all([
          getWeather(coords.lat, coords.lon),
          getNWSAlerts(coords.lat, coords.lon),
          getNESOutages(coords.lat, coords.lon)
        ]);

        // Cache data for re-rendering on language change
        cachedWeatherData = weather;
        cachedAlertsData = alerts;
        cachedOutagesData = outages;

        renderAlerts(alerts);
        renderOutages(outages);
        renderForecast(weather);
      } catch (err) {
        cachedWeatherData = null;
        cachedAlertsData = null;
        cachedOutagesData = null;
        showForecastError(t('forecast_error'));
        document.getElementById('alertsContainer').innerHTML = '';
        document.getElementById('outagesContainer').innerHTML = '';
        console.error(err);
      }
    }

    document.getElementById('fetchBtn').addEventListener('click', () => {
      trackActivity('weather_fetch', { zip: document.getElementById('zipInput').value });
      fetchForecast();
    });
    document.getElementById('zipInput').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        trackActivity('weather_fetch', { zip: document.getElementById('zipInput').value, method: 'enter_key' });
        fetchForecast();
      }
    });

    // Track external link clicks
    document.querySelectorAll('.external-link').forEach(link => {
      link.addEventListener('click', () => {
        const linkText = link.querySelector('span')?.textContent || link.textContent;
        trackActivity('resource_link_click', {
          url: link.dataset.href,
          text: linkText
        });
      });
    });

    // Track location button click
    document.querySelector('.location-btn')?.addEventListener('click', () => {
      trackActivity('location_btn_click', { destination: 'emergency.html' });
    });

    // ===========================================
    // OUTAGE MAP FUNCTIONALITY
    // ===========================================

    let previewMap = null;
    let fullMap = null;
    let previewOutageLayer = null;
    let fullOutageLayer = null;
    let cachedMapOutages = [];
    let mapStatsData = { customers: 0, crews: 0, waiting: 0 };

    // Warming centers data - Official locations from Nashville.gov
    // Last verified: January 29, 2026
    // Source: https://www.nashville.gov/departments/emergency-management/news/new-warming-location-opens-at-bellevue-community-center
    const WARMING_CENTERS_VERIFIED_DATE = '2026-01-29';
    const WARMING_CENTERS_EXPIRY_DAYS = 3;

    const warmingCenters = [
      { lat: 36.0679, lng: -86.6675, name: "Southeast Regional Community Center", address: "5260 Hickory Hollow Pkwy, Suite 202, Antioch, TN 37013", hasFood: true },
      { lat: 36.2573, lng: -86.7093, name: "Madison Community Center", address: "550 N Dupont Ave, Madison, TN 37115", hasFood: true },
      { lat: 36.1409, lng: -86.7634, name: "Nashville Fairgrounds", address: "401 Wingrove St, Nashville, TN 37203", hasFood: true },
      { lat: 36.0771, lng: -86.9208, name: "Bellevue Community Center", address: "7638A Highway 70 S, Nashville, TN 37221", hasFood: true }
    ];

    function isWarmingDataStale() {
      const verifiedDate = new Date(WARMING_CENTERS_VERIFIED_DATE);
      const now = new Date();
      const daysDiff = (now - verifiedDate) / (1000 * 60 * 60 * 24);
      return daysDiff > WARMING_CENTERS_EXPIRY_DAYS;
    }

    function getMapStatusColor(status) {
      const s = (status || '').toLowerCase();
      if (s.includes('crew en route') || s.includes('crew on site') || s.includes('assessing')) {
        return '#4ade80'; // green - being worked
      } else if (s.includes('unassigned') || s.includes('waiting')) {
        // Check unassigned BEFORE assigned (since 'unassigned' contains 'assigned')
        return '#f87171'; // red - unassigned/waiting
      } else if (s.includes('assigned') || s.includes('scheduled')) {
        return '#fbbf24'; // yellow - assigned
      } else {
        return '#f87171'; // red - unknown defaults to waiting
      }
    }

    function getMapStatusCategory(status) {
      const s = (status || '').toLowerCase();
      if (s.includes('crew en route') || s.includes('crew on site') || s.includes('assessing')) {
        return 'working';
      } else if (s.includes('unassigned') || s.includes('waiting')) {
        // Check unassigned BEFORE assigned (since 'unassigned' contains 'assigned')
        return 'unassigned';
      } else if (s.includes('assigned') || s.includes('scheduled')) {
        return 'assigned';
      } else {
        return 'unassigned'; // unknown defaults to waiting
      }
    }

    function getMapStatusText(status) {
      const cat = getMapStatusCategory(status);
      switch(cat) {
        case 'unassigned': return t('map_legend_waiting');
        case 'assigned': return t('map_legend_assigned');
        case 'working': return t('map_legend_working');
        default: return status || 'Unknown';
      }
    }

    function createOutagePopup(customers, status) {
      const statusClass = getMapStatusCategory(status);
      return `
        <div class="outage-popup">
          <div class="outage-popup-status ${statusClass}">${getMapStatusText(status)}</div>
          <div class="outage-popup-info">
            <strong>${customers.toLocaleString()}</strong> ${t('map_popup_customers')}
          </div>
        </div>
      `;
    }

    function createWarmingCenterPopup(name, address, hasFood) {
      const isStale = isWarmingDataStale();
      const statusText = isStale ? t('map_warming_unconfirmed') : t('map_warming_open');
      const statusClass = isStale ? 'unconfirmed' : '';
      const foodNote = hasFood ? `<div class="outage-popup-info" style="margin-top: 4px; color: #4ade80;">✓ ${t('map_warming_food')}</div>` : '';

      return `
        <div class="outage-popup">
          <div class="warming-popup-title">${name}</div>
          <div class="warming-popup-status ${statusClass}">${statusText}</div>
          <div class="outage-popup-info">${address}</div>
          ${foodNote}
          <a href="https://www.nashville.gov/departments/emergency-management" target="_blank" rel="noopener"
             style="display: block; margin-top: 8px; font-size: 0.75rem; color: #60a5fa;">
            ${t('map_warming_verify_link')} →
          </a>
        </div>
      `;
    }

    function addOutageMarkers(map, layer) {
      layer.clearLayers();

      cachedMapOutages.forEach(event => {
        const lat = event.lat || event.latitude;
        const lng = event.lng || event.longitude;
        const customers = event.customersAffected || event.customers_affected || event.numPeople || 1;
        const status = event.status || event.crewStatus || 'Unassigned';

        if (!lat || !lng) return;

        const color = getMapStatusColor(status);
        const radius = Math.min(Math.max(Math.sqrt(customers) * 1.2, 6), 30);

        const marker = L.circleMarker([lat, lng], {
          radius: radius,
          fillColor: color,
          color: '#1e293b',
          weight: 1.5,
          opacity: 1,
          fillOpacity: 0.75
        }).addTo(layer);

        marker.bindPopup(() => createOutagePopup(customers, status));
      });

      // Add warming center markers
      const warmingIcon = L.divIcon({
        className: '',
        html: '<div class="warming-center-icon">🏠</div>',
        iconSize: [28, 28],
        iconAnchor: [14, 14]
      });

      warmingCenters.forEach(center => {
        const marker = L.marker([center.lat, center.lng], { icon: warmingIcon }).addTo(layer);
        marker.bindPopup(() => createWarmingCenterPopup(center.name, center.address, center.hasFood));
      });
    }

    function updateMapStats() {
      // Update preview stats
      const customersEl = document.getElementById('mapStatCustomers');
      const crewsEl = document.getElementById('mapStatCrews');
      const waitingEl = document.getElementById('mapStatWaiting');

      if (customersEl) {
        customersEl.textContent = mapStatsData.customers > 1000
          ? Math.round(mapStatsData.customers / 1000) + 'K'
          : mapStatsData.customers.toLocaleString();
      }
      if (crewsEl) crewsEl.textContent = mapStatsData.crews.toLocaleString();
      if (waitingEl) waitingEl.textContent = mapStatsData.waiting.toLocaleString();

      // Update modal stats
      const modalCustomersEl = document.getElementById('modalStatCustomers');
      const modalCrewsEl = document.getElementById('modalStatCrews');
      const modalWaitingEl = document.getElementById('modalStatWaiting');

      if (modalCustomersEl) {
        modalCustomersEl.textContent = mapStatsData.customers > 1000
          ? Math.round(mapStatsData.customers / 1000) + 'K'
          : mapStatsData.customers.toLocaleString();
      }
      if (modalCrewsEl) modalCrewsEl.textContent = mapStatsData.crews.toLocaleString();
      if (modalWaitingEl) modalWaitingEl.textContent = mapStatsData.waiting.toLocaleString();
    }

    async function fetchMapOutages() {
      try {
        const response = await fetch('https://utilisocial.io/datacapable/v2/p/NES/map/events');
        const data = await response.json();

        const events = data.events || data || [];
        cachedMapOutages = events;

        let totalCustomers = 0;
        let crewsWorking = 0;
        let unassignedCount = 0;

        events.forEach(event => {
          const customers = event.customersAffected || event.customers_affected || event.numPeople || 1;
          const status = event.status || event.crewStatus || 'Unassigned';

          totalCustomers += customers;
          const cat = getMapStatusCategory(status);
          if (cat === 'working' || cat === 'assigned') {
            crewsWorking++;
          } else {
            unassignedCount++;
          }
        });

        mapStatsData = {
          customers: totalCustomers,
          crews: crewsWorking,
          waiting: unassignedCount
        };

        updateMapStats();

        if (previewOutageLayer) {
          addOutageMarkers(previewMap, previewOutageLayer);
        }
        if (fullOutageLayer) {
          addOutageMarkers(fullMap, fullOutageLayer);
        }

        console.log(`Map: Loaded ${events.length} outage events, ${totalCustomers} customers affected`);

      } catch (error) {
        console.error('Failed to fetch map outage data:', error);
      }
    }

    function initPreviewMap() {
      if (previewMap) return;

      const mapContainer = document.getElementById('outageMapPreview');
      if (!mapContainer) return;

      previewMap = L.map('outageMapPreview', {
        zoomControl: false,
        attributionControl: false,
        dragging: false,
        scrollWheelZoom: false,
        doubleClickZoom: false,
        touchZoom: false
      }).setView([36.1627, -86.7816], 10);

      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 18
      }).addTo(previewMap);

      previewOutageLayer = L.layerGroup().addTo(previewMap);

      // If we already have data, add markers
      if (cachedMapOutages.length > 0) {
        addOutageMarkers(previewMap, previewOutageLayer);
      }
    }

    function initFullMap() {
      if (fullMap) {
        // Just invalidate size if already exists
        setTimeout(() => fullMap.invalidateSize(), 100);
        return;
      }

      const mapContainer = document.getElementById('outageMapFull');
      if (!mapContainer) return;

      fullMap = L.map('outageMapFull', {
        zoomControl: true
      }).setView([36.1627, -86.7816], 11);

      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap contributors',
        maxZoom: 18
      }).addTo(fullMap);

      fullOutageLayer = L.layerGroup().addTo(fullMap);

      // If we already have data, add markers
      if (cachedMapOutages.length > 0) {
        addOutageMarkers(fullMap, fullOutageLayer);
      }
    }

    function openMapModal() {
      const modal = document.getElementById('mapModal');
      if (modal) {
        modal.classList.add('active');
        document.body.style.overflow = 'hidden';

        // Initialize or resize the full map
        setTimeout(() => {
          initFullMap();
        }, 50);

        trackActivity('map_modal_open');
      }
    }

    function closeMapModal() {
      const modal = document.getElementById('mapModal');
      if (modal) {
        modal.classList.remove('active');
        document.body.style.overflow = '';
      }
    }

    // Close modal with Escape key
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        closeMapModal();
      }
    });

    // Initialize preview map when page loads
    setTimeout(() => {
      initPreviewMap();
      fetchMapOutages();
    }, 500);

    // Refresh map data every 2 minutes
    setInterval(fetchMapOutages, 120000);

    // Load forecast on page load
    fetchForecast();
  </script>
</body>
</html>
