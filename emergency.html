<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>911 Emergency Location</title>
    <link rel="icon" type="image/png" href="https://substackcdn.com/image/fetch/w_80,h_80,c_fill,f_png,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F4253394d-9735-40dd-961c-daa685b93262_1024x1024.png">
    <style>
        :root {
            /* Text scaling - adjustable via JS */
            --text-scale: 1;

            /* Core colors */
            --color-bg-primary: #b91c1c;
            --color-bg-dark: #7f1d1d;

            /* Text colors - improved contrast */
            --color-text-primary: #ffffff;
            --color-text-secondary: #fecaca;  /* Light red for contrast on red bg */
            --color-text-dark: #111827;

            /* Accent colors */
            --color-focus: #60a5fa;
        }

        /* Text size variants */
        html.text-small { --text-scale: 0.9; }
        html.text-normal { --text-scale: 1; }
        html.text-large { --text-scale: 1.15; }
        html.text-xlarge { --text-scale: 1.3; }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        html {
            font-size: calc(16px * var(--text-scale));
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, var(--color-bg-primary) 0%, var(--color-bg-dark) 100%);
            min-height: 100vh;
            min-height: 100dvh;
            padding: 16px;
            padding-top: max(16px, env(safe-area-inset-top));
            padding-bottom: max(16px, env(safe-area-inset-bottom));
            padding-left: max(16px, env(safe-area-inset-left));
            padding-right: max(16px, env(safe-area-inset-right));
        }

        [dir="rtl"] { font-family: 'Segoe UI', Tahoma, Arial, sans-serif; }
        [dir="rtl"] .info-card-label { flex-direction: row-reverse; }
        [dir="rtl"] .gps-badge { margin-left: 0; margin-right: auto; }
        [dir="rtl"] .btn-call, [dir="rtl"] .btn-text, [dir="rtl"] .btn-copy, [dir="rtl"] .btn-refresh, [dir="rtl"] .btn-text-other { flex-direction: row-reverse; }
        [dir="rtl"] .privacy-notice { text-align: right; }

        .container { max-width: 420px; margin: 0 auto; }

        .lang-selector {
            display: flex; gap: 6px; flex-wrap: wrap;
            justify-content: center; margin-bottom: 12px;
        }

        .lang-btn {
            padding: 0.5rem 0.75rem;
            border: 2px solid rgba(255,255,255,0.3);
            background: rgba(255,255,255,0.1);
            color: white; border-radius: 8px;
            font-size: 0.8125rem; font-weight: 600;
            cursor: pointer; transition: all 0.2s;
            min-height: 44px;
            touch-action: manipulation;
        }

        .lang-btn:hover { background: rgba(255,255,255,0.2); }
        .lang-btn:active { transform: scale(0.97); }
        .lang-btn.active { background: white; color: #7f1d1d; border-color: white; }
        .lang-btn:focus-visible { outline: 2px solid var(--color-focus); outline-offset: 2px; }

        /* Accessibility controls */
        .a11y-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            align-items: center;
            margin-bottom: 12px;
        }

        /* Text size controls */
        .text-size-controls {
            display: flex;
            align-items: center;
            gap: 4px;
            background: rgba(255,255,255,0.1);
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 8px;
            padding: 4px;
        }

        .text-size-btn {
            background: transparent;
            border: none;
            color: rgba(255,255,255,0.8);
            width: 36px;
            height: 36px;
            min-height: 44px;
            min-width: 44px;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.875rem;
            transition: all 0.15s ease;
            touch-action: manipulation;
        }

        .text-size-btn:hover {
            background: rgba(255,255,255,0.15);
            color: white;
        }

        .text-size-btn:focus-visible {
            outline: 2px solid var(--color-focus);
            outline-offset: 1px;
        }

        .text-size-btn.active {
            background: rgba(255,255,255,0.25);
            color: white;
        }

        .header {
            background: #7f1d1d; color: white;
            padding: 16px 20px; text-align: center;
            border-radius: 16px 16px 0 0;
        }

        .app-logo {
            width: 50px;
            height: auto;
            margin-bottom: 8px;
        }

        .header h1 {
            font-size: 1.375rem; font-weight: 700;
            display: flex; align-items: center; justify-content: center; gap: 0.5rem;
        }

        .header p { color: var(--color-text-secondary); font-size: 0.8125rem; margin-top: 0.25rem; }

        .privacy-notice {
            background: #065f46;
            color: white;
            padding: 0.75rem 1rem;
            font-size: 0.8125rem;
            display: flex;
            align-items: flex-start;
            gap: 0.625rem;
            line-height: 1.4;
        }

        .privacy-notice svg {
            flex-shrink: 0;
            margin-top: 2px;
        }

        .emergency-buttons {
            background: #fee2e2; padding: 16px;
            display: grid; grid-template-columns: 1fr 1fr; gap: 12px;
        }

        .btn-call, .btn-text {
            padding: 1.125rem 1rem; border: none; border-radius: 12px;
            font-weight: 700; font-size: 1.0625rem; cursor: pointer;
            display: flex; align-items: center; justify-content: center; gap: 0.5rem;
            transition: transform 0.1s; text-decoration: none; color: white;
            min-height: 56px;
            touch-action: manipulation;
        }

        .btn-call {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
            box-shadow: 0 4px 12px rgba(185, 28, 28, 0.4);
        }

        .btn-text {
            background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.4);
        }

        .btn-call:active, .btn-text:active { transform: scale(0.96); }

        .content { background: white; padding: 16px; }

        .info-card { border-radius: 12px; padding: 14px 16px; margin-bottom: 12px; }
        .info-card:last-child { margin-bottom: 0; }

        .info-card-label {
            font-size: 0.75rem; font-weight: 600; text-transform: uppercase;
            letter-spacing: 0.5px; display: flex; align-items: center; gap: 0.375rem;
        }

        .info-card-value {
            font-size: 1.25rem; font-weight: 700; color: #111; margin-top: 0.375rem;
            font-family: 'SF Mono', 'Monaco', 'Consolas', monospace;
        }

        .info-card-hint { font-size: 0.6875rem; color: #6b7280; margin-top: 0.25rem; font-style: italic; }

        .gps-card { background: #ecfdf5; border: 2px solid #10b981; }
        .gps-card .info-card-label { color: #065f46; }

        .gps-badge {
            background: #10b981; color: white; font-size: 0.625rem;
            padding: 0.1875rem 0.5rem; border-radius: 20px; margin-left: auto;
        }

        .accuracy-text { font-size: 0.8125rem; margin-top: 0.5rem; font-weight: 500; }
        .accuracy-excellent { color: #059669; }
        .accuracy-good { color: #2563eb; }
        .accuracy-moderate { color: #d97706; }
        .accuracy-poor { color: #dc2626; }

        .intersection-card { background: #fffbeb; border: 1px solid #fbbf24; }
        .intersection-card .info-card-label { color: #92400e; }
        .intersection-value { font-family: -apple-system, BlinkMacSystemFont, sans-serif; font-size: 1.125rem; }

        .address-card { background: #f9fafb; border: 1px solid #e5e7eb; }
        .address-card .info-card-label { color: #4b5563; }
        .address-card .info-card-value { font-family: -apple-system, BlinkMacSystemFont, sans-serif; font-size: 1.0625rem; }

        .maps-card { background: #eff6ff; border: 1px solid #93c5fd; }
        .maps-card .info-card-label { color: #1d4ed8; }
        .maps-link { color: #2563eb; font-size: 0.8125rem; word-break: break-all; display: block; margin-top: 0.375rem; }

        .actions { background: #f3f4f6; padding: 16px; border-radius: 0 0 16px 16px; }

        .btn-copy, .btn-text-other {
            width: 100%; padding: 1rem; border: none; border-radius: 12px;
            font-weight: 700; font-size: 1rem; cursor: pointer;
            display: flex; align-items: center; justify-content: center; gap: 0.5rem;
            transition: all 0.2s; margin-bottom: 0.75rem;
            min-height: 52px;
            touch-action: manipulation;
        }

        .btn-copy {
            background: #1f2937; color: white;
        }

        .btn-copy:hover { background: #111827; }
        .btn-copy:active { transform: scale(0.98); }
        .btn-copy.copied { background: #059669; }

        .btn-text-other {
            background: linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(124, 58, 237, 0.3);
        }

        .btn-text-other:hover { opacity: 0.95; }
        .btn-text-other:active { transform: scale(0.98); }

        .btn-refresh {
            width: 100%; padding: 0.875rem; border: 2px solid #d1d5db; border-radius: 12px;
            font-weight: 600; font-size: 0.9375rem; cursor: pointer;
            display: flex; align-items: center; justify-content: center; gap: 0.5rem;
            background: white; color: #374151; transition: background 0.2s;
            min-height: 48px;
            touch-action: manipulation;
        }

        .btn-refresh:hover { background: #f9fafb; }
        .btn-refresh:active { transform: scale(0.98); }

        .instructions {
            background: rgba(255,255,255,0.9); border-radius: 12px;
            padding: 1rem; margin-top: 1rem; font-size: 0.875rem; color: #374151;
        }

        .instructions strong { color: #111; }

        .instructions .script {
            color: #1f2937; margin: 0.5rem 0;
            font-family: 'SF Mono', 'Monaco', 'Consolas', monospace;
            font-size: 0.8125rem; background: #f3f4f6;
            padding: 0.5rem 0.75rem; border-radius: 8px; white-space: pre-wrap;
        }

        .instructions .note {
            font-size: 0.75rem; color: #6b7280; margin-top: 0.75rem;
            padding-top: 0.75rem; border-top: 1px solid #e5e7eb;
        }

        .output-preview {
            background: #fefce8; border: 1px solid #fde047;
            border-radius: 8px; padding: 0.75rem; margin-top: 0.75rem; font-size: 0.75rem;
        }

        .output-preview-title { font-weight: 600; color: #854d0e; margin-bottom: 0.5rem; }

        .output-preview-content {
            font-family: 'SF Mono', 'Monaco', 'Consolas', monospace;
            font-size: 0.6875rem; color: #1f2937; white-space: pre-wrap;
            background: white; padding: 0.5rem; border-radius: 4px;
            max-height: 150px; overflow-y: auto;
        }

        .loading-container {
            background: white; border-radius: 16px; padding: 48px 24px;
            text-align: center; box-shadow: 0 20px 40px rgba(0,0,0,0.2);
        }

        .spinner {
            width: 56px; height: 56px; border: 4px solid #fee2e2;
            border-top-color: #dc2626; border-radius: 50%;
            animation: spin 1s linear infinite; margin: 0 auto 20px;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        .loading-container h2 { font-size: 1.25rem; color: #111; margin-bottom: 0.5rem; }
        .loading-container p { color: #6b7280; }

        .error-container {
            background: white; border-radius: 16px; padding: 48px 24px;
            text-align: center; box-shadow: 0 20px 40px rgba(0,0,0,0.2);
        }

        .error-icon {
            width: 56px; height: 56px; background: #fee2e2; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            margin: 0 auto 1.25rem; font-size: 1.75rem;
        }

        .error-container h2 { font-size: 1.25rem; color: #111; margin-bottom: 0.5rem; }
        .error-container p { color: #6b7280; margin-bottom: 1.5rem; }

        .btn-retry {
            background: #dc2626; color: white; border: none;
            padding: 0.875rem 2rem; border-radius: 12px; font-weight: 600; font-size: 1rem; cursor: pointer;
            min-height: 48px;
            touch-action: manipulation;
        }

        .btn-retry:active { transform: scale(0.98); }

        .hidden { display: none !important; }
        .icon { width: 22px; height: 22px; flex-shrink: 0; }
        .icon-sm { width: 16px; height: 16px; }

        .embedded-container {
            background: white; border-radius: 16px; padding: 32px 24px;
            text-align: center; box-shadow: 0 20px 40px rgba(0,0,0,0.2);
        }

        .embedded-icon {
            width: 64px; height: 64px; background: #fef3c7; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            margin: 0 auto 1.25rem; font-size: 2rem;
        }

        .embedded-container h2 { font-size: 1.25rem; color: #111; margin-bottom: 0.75rem; }
        .embedded-container p { color: #6b7280; margin-bottom: 1.5rem; line-height: 1.5; }

        .btn-open-new {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
            color: white; border: none;
            padding: 1rem 2rem; border-radius: 12px; font-weight: 700; font-size: 1rem; cursor: pointer;
            min-height: 52px;
            touch-action: manipulation;
            display: inline-flex; align-items: center; gap: 0.5rem;
            text-decoration: none;
            box-shadow: 0 4px 12px rgba(185, 28, 28, 0.4);
        }

        .btn-open-new:active { transform: scale(0.98); }

        .back-link {
            display: inline-flex;
            align-items: center;
            gap: 0.375rem;
            color: white;
            text-decoration: none;
            font-size: 0.875rem;
            margin-bottom: 0.75rem;
            opacity: 0.9;
            min-height: 44px;
            padding: 0.5rem 0;
        }

        .back-link:hover { opacity: 1; }

        @media (prefers-reduced-motion: reduce) {
            * { transition: none !important; }
            .spinner { animation: none; }
        }

        /* ===========================================
           ENHANCED MOBILE UX - Large Text Support
           =========================================== */

        /* Cap text scale on very small screens */
        @media (max-width: 360px) {
            html.text-xlarge { --text-scale: 1.15; }
            html.text-large { --text-scale: 1.05; }
        }

        @media (max-width: 320px) {
            html.text-xlarge { --text-scale: 1.1; }
            html.text-large { --text-scale: 1; }
        }

        /* Language selector stacking for small screens */
        @media (max-width: 380px) {
            .lang-selector {
                gap: 0.25rem;
            }

            .lang-btn {
                padding: 0.375rem 0.625rem;
                font-size: 0.75rem;
            }
        }

        @media (max-width: 320px) {
            .lang-selector {
                flex-wrap: wrap;
                justify-content: center;
            }
        }

        /* Emergency buttons - stack vertically on very small screens */
        @media (max-width: 360px) {
            .emergency-buttons {
                grid-template-columns: 1fr;
                gap: 0.625rem;
            }

            .btn-call, .btn-text {
                font-size: 0.9375rem;
                padding: 1rem 0.875rem;
            }
        }

        /* Info cards - better text handling */
        .info-card-value {
            word-break: break-word;
            overflow-wrap: break-word;
            hyphens: auto;
            font-size: clamp(1rem, 4.5vw, 1.25rem);
        }

        @media (max-width: 360px) {
            .info-card {
                padding: 0.75rem 0.875rem;
            }

            .info-card-label {
                font-size: 0.6875rem;
                flex-wrap: wrap;
            }

            .info-card-hint {
                font-size: 0.625rem;
            }

            .gps-badge {
                font-size: 0.5625rem;
                padding: 0.125rem 0.375rem;
            }

            .accuracy-text {
                font-size: 0.75rem;
            }

            .maps-link {
                font-size: 0.75rem;
            }
        }

        /* Address card - prevent overflow */
        .address-card .info-card-value {
            font-size: clamp(0.875rem, 4vw, 1.0625rem);
        }

        /* Actions section */
        @media (max-width: 360px) {
            .actions {
                padding: 0.875rem;
            }

            .btn-copy, .btn-text-other {
                font-size: 0.875rem;
                padding: 0.875rem;
            }

            .btn-refresh {
                font-size: 0.8125rem;
                padding: 0.75rem;
            }
        }

        /* Instructions - better mobile handling */
        @media (max-width: 380px) {
            .instructions {
                padding: 0.875rem;
                font-size: 0.8125rem;
            }

            .instructions .script {
                font-size: 0.6875rem;
                padding: 0.375rem 0.625rem;
            }

            .output-preview-content {
                font-size: 0.625rem;
            }
        }

        /* Header adjustments for large text */
        @media (max-width: 380px) {
            .header {
                padding: 0.875rem 1rem;
            }

            .header h1 {
                font-size: clamp(1.125rem, 5vw, 1.375rem);
                flex-wrap: wrap;
                gap: 0.375rem;
            }

            .header p {
                font-size: 0.75rem;
            }
        }

        /* Privacy notice - ensure readability */
        @media (max-width: 380px) {
            .privacy-notice {
                padding: 0.625rem 0.875rem;
                font-size: 0.75rem;
            }
        }

        /* Global touch target improvements */
        .btn-call, .btn-text, .btn-copy, .btn-text-other, .btn-refresh, .btn-retry, .btn-open-new, .lang-btn {
            min-height: 44px;
        }

        /* Improved touch feedback */
        @media (hover: none) and (pointer: coarse) {
            .btn-call:active, .btn-text:active, .btn-copy:active, .btn-text-other:active,
            .btn-refresh:active, .btn-retry:active, .btn-open-new:active, .lang-btn:active,
            .text-size-btn:active {
                opacity: 0.9;
            }
        }

        /* Prevent horizontal overflow */
        html, body {
            overflow-x: hidden;
            max-width: 100vw;
        }

        .container {
            overflow-x: hidden;
        }

        /* Text overflow handling */
        h1, h2, p, .info-card-value {
            overflow-wrap: break-word;
            word-wrap: break-word;
        }

        /* Safe area improvements for notched phones */
        @supports (padding: max(0px)) {
            .container {
                padding-left: max(0px, env(safe-area-inset-left));
                padding-right: max(0px, env(safe-area-inset-right));
            }
        }

        /* Large text specific adjustments */
        html.text-large .header h1,
        html.text-xlarge .header h1 {
            font-size: clamp(1.125rem, 5vw, 1.5rem);
        }

        html.text-large .info-card-value,
        html.text-xlarge .info-card-value {
            font-size: clamp(1rem, 4.5vw, 1.375rem);
        }

        @media (max-width: 400px) {
            html.text-large .btn-call,
            html.text-large .btn-text,
            html.text-xlarge .btn-call,
            html.text-xlarge .btn-text {
                font-size: 0.9375rem;
            }

            html.text-large .btn-copy,
            html.text-large .btn-text-other,
            html.text-xlarge .btn-copy,
            html.text-xlarge .btn-text-other {
                font-size: 0.875rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <a href="index.html" class="back-link">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M19 12H5M12 19l-7-7 7-7"/>
            </svg>
            <span data-i18n="back_to_resources">Back to Resources</span>
        </a>

        <div class="a11y-controls">
            <div class="lang-selector">
                <button class="lang-btn active" data-lang="en">EN</button>
                <button class="lang-btn" data-lang="es">ES</button>
                <button class="lang-btn" data-lang="ar">ÿßŸÑÿπÿ±ÿ®Ÿäÿ©</button>
                <button class="lang-btn" data-lang="ku">⁄©Ÿàÿ±ÿØ€å</button>
                <button class="lang-btn" data-lang="vi">VI</button>
            </div>
            <div class="text-size-controls" role="group" aria-label="Text size">
                <button class="text-size-btn" data-size="small" aria-label="Small text" title="Smaller text" style="font-size: 12px;">A</button>
                <button class="text-size-btn active" data-size="normal" aria-label="Normal text" title="Normal text">A</button>
                <button class="text-size-btn" data-size="large" aria-label="Large text" title="Larger text" style="font-size: 18px;">A</button>
                <button class="text-size-btn" data-size="xlarge" aria-label="Extra large text" title="Extra large text" style="font-size: 22px;">A</button>
            </div>
        </div>

        <div id="loadingState" class="loading-container">
            <div class="spinner"></div>
            <h2 data-i18n="loading_title">Getting Your Location</h2>
            <p data-i18n="loading_desc">Please allow location access when prompted...</p>
        </div>

        <div id="errorState" class="error-container hidden">
            <div class="error-icon">‚ö†Ô∏è</div>
            <h2 data-i18n="error_title">Location Error</h2>
            <p id="errorMessage" data-i18n="error_generic">Unable to get your location.</p>
            <button class="btn-retry" onclick="getLocation()" data-i18n="try_again">Try Again</button>
        </div>

        <div id="embeddedState" class="embedded-container hidden">
            <div class="embedded-icon">üìç</div>
            <h2 data-i18n="embedded_title">Location Access Needed</h2>
            <p data-i18n="embedded_desc">For your safety, location access requires opening this page directly. Tap the button below to get your location for 911.</p>
            <a href="" id="openNewBtn" class="btn-open-new" target="_blank">
                <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/>
                    <polyline points="15 3 21 3 21 9"/>
                    <line x1="10" y1="14" x2="21" y2="3"/>
                </svg>
                <span data-i18n="open_new_btn">Open 911 Location Tool</span>
            </a>
        </div>

        <div id="mainContent" class="hidden">
            <div class="header">
                <img src="https://assets.softr-files.com/applications/26b1b861-7748-4f49-8539-21dc6ca9c679/assets/58e44c7c-d691-468e-a9c0-68bfe0c8fd21.png" alt="Nashville Resources Logo" class="app-logo">
                <h1>
                    <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
                        <line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/>
                    </svg>
                    <span data-i18n="title">911 Emergency Location</span>
                </h1>
                <p data-i18n="subtitle">Share your exact location with emergency services</p>
            </div>

            <div class="privacy-notice">
                <svg class="icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
                    <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
                </svg>
                <span data-i18n="privacy_notice">Your location stays private on your device. Nothing is shared unless YOU choose to send it via call, text, or copy.</span>
            </div>

            <div class="emergency-buttons">
                <a href="tel:911" class="btn-call">
                    <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/>
                    </svg>
                    <span data-i18n="call_911">CALL 911</span>
                </a>
                <a href="#" id="textBtn" class="btn-text">
                    <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                    </svg>
                    <span data-i18n="text_911">TEXT 911</span>
                </a>
            </div>

            <div class="content">
                <div class="info-card gps-card">
                    <div class="info-card-label">
                        <svg class="icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polygon points="3 11 22 2 13 21 11 13 3 11"/>
                        </svg>
                        <span data-i18n="gps_label">GPS COORDINATES</span>
                        <span class="gps-badge" data-i18n="gps_badge">911 UNIVERSAL</span>
                    </div>
                    <div class="info-card-value" id="gpsCoords">‚Äî</div>
                    <div class="info-card-hint" data-i18n="gps_hint">This is what 911 dispatchers need most</div>
                    <div class="accuracy-text" id="accuracyText"></div>
                </div>

                <div class="info-card intersection-card" id="intersectionCard" style="display:none;">
                    <div class="info-card-label">üö¶ <span data-i18n="intersection_label">NEAREST INTERSECTION</span></div>
                    <div class="info-card-value intersection-value" id="intersection">‚Äî</div>
                    <div class="info-card-hint" data-i18n="intersection_hint">Cross streets help responders find you</div>
                </div>

                <div class="info-card address-card" id="addressCard" style="display:none;">
                    <div class="info-card-label">üì´ <span data-i18n="address_label">STREET ADDRESS</span></div>
                    <div class="info-card-value" id="streetAddress">‚Äî</div>
                </div>

                <div class="info-card maps-card">
                    <div class="info-card-label">üó∫Ô∏è <span data-i18n="maps_label">GOOGLE MAPS</span></div>
                    <a class="maps-link" id="mapsLink" href="#" target="_blank">‚Äî</a>
                </div>
            </div>

            <div class="actions">
                <button class="btn-copy" id="copyBtn" onclick="copyToClipboard()">
                    <svg class="icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="9" y="9" width="13" height="13" rx="2" ry="2"/>
                        <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/>
                    </svg>
                    <span data-i18n="copy_btn">Copy All Info</span>
                </button>

                <button class="btn-text-other" id="textOtherBtn" onclick="textSomeoneElse()">
                    <svg class="icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
                        <polyline points="22,6 12,13 2,6"/>
                    </svg>
                    <span data-i18n="text_other_btn">Text Someone Else</span>
                </button>

                <button class="btn-refresh" onclick="getLocation()">
                    <svg class="icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="23 4 23 10 17 10"/><polyline points="1 20 1 14 7 14"/>
                        <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/>
                    </svg>
                    <span data-i18n="refresh_btn">Refresh Location</span>
                </button>

                <div class="output-preview">
                    <div class="output-preview-title" data-i18n="preview_title">üì§ Message preview (in English for 911):</div>
                    <div class="output-preview-content" id="outputPreview">‚Äî</div>
                </div>
            </div>

            <div class="instructions">
                <strong data-i18n="instructions_title">üìû When calling 911, say:</strong>
                <p class="script" id="callScript">"My GPS coordinates are..."</p>
                <p class="note" data-i18n="text_911_note">Nashville/Davidson County supports Text-to-911. Text if you cannot safely speak.</p>
            </div>
        </div>

        <footer style="text-align: center; margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid rgba(255, 255, 255, 0.2); color: var(--color-text-secondary); font-size: 0.8rem;">
            Brought to you by <a href="https://readrichtext.substack.com/" target="_blank" rel="noopener" style="color: #ffffff;">Rich Text</a> and <a href="https://groundtruthnashville.substack.com/" target="_blank" rel="noopener" style="color: #ffffff;">Ground Truth Nashville</a>
        </footer>
    </div>

    <script>
        // ===========================================
        // WEBHOOK ACTIVITY TRACKING
        // ===========================================
        const WEBHOOK_URL = 'https://n8n.intelechia.com/webhook/citycastnashville';

        function trackActivity(action, details = {}) {
          try {
            const payload = {
              page: 'emergency',
              action: action,
              details: details,
              timestamp: new Date().toISOString(),
              language: localStorage.getItem('nashville-resources-lang') || 'en',
              userAgent: navigator.userAgent,
              referrer: document.referrer || null
            };

            console.log('[Webhook] Sending:', action, payload);

            fetch(WEBHOOK_URL, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(payload),
              keepalive: true
            })
            .then(response => {
              console.log('[Webhook] Response:', response.status, response.statusText);
              if (!response.ok) {
                console.error('[Webhook] Failed with status:', response.status);
              }
            })
            .catch(error => {
              console.error('[Webhook] Error:', error.message || error);
            });
          } catch (e) {
            console.error('[Webhook] Exception:', e);
          }
        }

        // Track page load
        trackActivity('page_load', { url: window.location.href });

        const translations = {
            en: {
                back_to_resources: "Back to Resources",
                loading_title: "Getting Your Location",
                loading_desc: "Please allow location access when prompted...",
                error_title: "Location Error",
                error_generic: "Unable to get your location.",
                error_denied: "Location access denied. Please enable location permissions.",
                error_unavailable: "Location unavailable. Please try again.",
                error_timeout: "Location request timed out. Please try again.",
                try_again: "Try Again",
                embedded_title: "Location Access Needed",
                embedded_desc: "For your safety, location access requires opening this page directly. Tap the button below to get your location for 911.",
                open_new_btn: "Open 911 Location Tool",
                title: "911 Emergency Location",
                subtitle: "Share your exact location with emergency services",
                privacy_notice: "Your location stays private on your device. Nothing is shared unless YOU choose to send it via call, text, or copy.",
                call_911: "CALL 911",
                text_911: "TEXT 911",
                gps_label: "GPS COORDINATES",
                gps_badge: "911 UNIVERSAL",
                gps_hint: "This is what 911 dispatchers need most",
                intersection_label: "NEAREST INTERSECTION",
                intersection_hint: "Cross streets help responders find you",
                address_label: "STREET ADDRESS",
                maps_label: "GOOGLE MAPS",
                copy_btn: "Copy All Info",
                copy_success: "Copied!",
                text_other_btn: "Text Someone Else",
                refresh_btn: "Refresh Location",
                preview_title: "üì§ Message preview (in English for 911):",
                instructions_title: "üìû When calling 911, say:",
                text_911_note: "Nashville/Davidson County supports Text-to-911. Text if you cannot safely speak.",
                accuracy_excellent: "Accuracy: Excellent",
                accuracy_good: "Accuracy: Good",
                accuracy_moderate: "Accuracy: Moderate",
                accuracy_poor: "Accuracy: Approximate"
            },
            es: {
                back_to_resources: "Volver a Recursos",
                loading_title: "Obteniendo Tu Ubicaci√≥n",
                loading_desc: "Permite el acceso a la ubicaci√≥n cuando se solicite...",
                error_title: "Error de Ubicaci√≥n",
                error_generic: "No se puede obtener tu ubicaci√≥n.",
                error_denied: "Acceso denegado. Habilita los permisos de ubicaci√≥n.",
                error_unavailable: "Ubicaci√≥n no disponible. Intenta de nuevo.",
                error_timeout: "Tiempo agotado. Intenta de nuevo.",
                try_again: "Intentar de Nuevo",
                embedded_title: "Se Necesita Acceso a Ubicaci√≥n",
                embedded_desc: "Por tu seguridad, el acceso a la ubicaci√≥n requiere abrir esta p√°gina directamente. Toca el bot√≥n para obtener tu ubicaci√≥n para 911.",
                open_new_btn: "Abrir Herramienta 911",
                title: "Ubicaci√≥n de Emergencia 911",
                subtitle: "Comparte tu ubicaci√≥n con servicios de emergencia",
                privacy_notice: "Tu ubicaci√≥n permanece privada en tu dispositivo. No se comparte nada a menos que T√ö elijas enviarlo por llamada, mensaje o copia.",
                call_911: "LLAMAR 911",
                text_911: "MENSAJE 911",
                gps_label: "COORDENADAS GPS",
                gps_badge: "911 UNIVERSAL",
                gps_hint: "Esto es lo que m√°s necesita el 911",
                intersection_label: "INTERSECCI√ìN M√ÅS CERCANA",
                intersection_hint: "Las calles cruzadas ayudan a encontrarte",
                address_label: "DIRECCI√ìN",
                maps_label: "GOOGLE MAPS",
                copy_btn: "Copiar Todo",
                copy_success: "¬°Copiado!",
                text_other_btn: "Enviar a Otra Persona",
                refresh_btn: "Actualizar Ubicaci√≥n",
                preview_title: "üì§ Vista previa (en ingl√©s para 911):",
                instructions_title: "üìû Al llamar al 911, di en ingl√©s:",
                text_911_note: "Nashville tiene texto al 911. Env√≠a mensaje si no puedes hablar.",
                accuracy_excellent: "Precisi√≥n: Excelente",
                accuracy_good: "Precisi√≥n: Buena",
                accuracy_moderate: "Precisi√≥n: Moderada",
                accuracy_poor: "Precisi√≥n: Aproximada"
            },
            ar: {
                back_to_resources: "ÿßŸÑÿπŸàÿØÿ© ÿ•ŸÑŸâ ÿßŸÑŸÖŸàÿßÿ±ÿØ",
                loading_title: "ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ≠ÿµŸàŸÑ ÿπŸÑŸâ ŸÖŸàŸÇÿπŸÉ",
                loading_desc: "Ÿäÿ±ÿ¨Ÿâ ÿßŸÑÿ≥ŸÖÿßÿ≠ ÿ®ÿßŸÑŸàÿµŸàŸÑ ÿ•ŸÑŸâ ÿßŸÑŸÖŸàŸÇÿπ...",
                error_title: "ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑŸÖŸàŸÇÿπ",
                error_generic: "ÿ™ÿπÿ∞ÿ± ÿßŸÑÿ≠ÿµŸàŸÑ ÿπŸÑŸâ ŸÖŸàŸÇÿπŸÉ.",
                error_denied: "ÿ™ŸÖ ÿ±ŸÅÿ∂ ÿßŸÑŸàÿµŸàŸÑ. Ÿäÿ±ÿ¨Ÿâ ÿ™ŸÖŸÉŸäŸÜ ÿßŸÑÿ£ÿ∞ŸàŸÜÿßÿ™.",
                error_unavailable: "ÿßŸÑŸÖŸàŸÇÿπ ÿ∫Ÿäÿ± ŸÖÿ™ŸàŸÅÿ±. ÿ≠ÿßŸàŸÑ ŸÖÿ±ÿ© ÿ£ÿÆÿ±Ÿâ.",
                error_timeout: "ÿßŸÜÿ™Ÿáÿ™ ÿßŸÑŸÖŸáŸÑÿ©. ÿ≠ÿßŸàŸÑ ŸÖÿ±ÿ© ÿ£ÿÆÿ±Ÿâ.",
                try_again: "ÿ≠ÿßŸàŸÑ ŸÖÿ±ÿ© ÿ£ÿÆÿ±Ÿâ",
                embedded_title: "ŸÖÿ∑ŸÑŸàÿ® ÿßŸÑŸàÿµŸàŸÑ ÿ•ŸÑŸâ ÿßŸÑŸÖŸàŸÇÿπ",
                embedded_desc: "ŸÑÿ≥ŸÑÿßŸÖÿ™ŸÉÿå Ÿäÿ™ÿ∑ŸÑÿ® ÿßŸÑŸàÿµŸàŸÑ ÿ•ŸÑŸâ ÿßŸÑŸÖŸàŸÇÿπ ŸÅÿ™ÿ≠ Ÿáÿ∞Ÿá ÿßŸÑÿµŸÅÿ≠ÿ© ŸÖÿ®ÿßÿ¥ÿ±ÿ©. ÿßÿ∂ÿ∫ÿ∑ ÿßŸÑÿ≤ÿ± ŸÑŸÑÿ≠ÿµŸàŸÑ ÿπŸÑŸâ ŸÖŸàŸÇÿπŸÉ ŸÑŸÄ 911.",
                open_new_btn: "ŸÅÿ™ÿ≠ ÿ£ÿØÿßÿ© 911",
                title: "ŸÖŸàŸÇÿπ ÿ∑Ÿàÿßÿ±ÿ¶ 911",
                subtitle: "ÿ¥ÿßÿ±ŸÉ ŸÖŸàŸÇÿπŸÉ ŸÖÿπ ÿÆÿØŸÖÿßÿ™ ÿßŸÑÿ∑Ÿàÿßÿ±ÿ¶",
                privacy_notice: "ŸÖŸàŸÇÿπŸÉ Ÿäÿ®ŸÇŸâ ÿÆÿßÿµÿßŸã ÿπŸÑŸâ ÿ¨Ÿáÿßÿ≤ŸÉ. ŸÑÿß Ÿäÿ™ŸÖ ŸÖÿ¥ÿßÿ±ŸÉÿ© ÿ£Ÿä ÿ¥Ÿäÿ° ÿ•ŸÑÿß ÿ•ÿ∞ÿß ÿßÿÆÿ™ÿ±ÿ™ ÿ£ŸÜÿ™ ÿ•ÿ±ÿ≥ÿßŸÑŸá ÿπÿ®ÿ± ŸÖŸÉÿßŸÑŸÖÿ© ÿ£Ÿà ÿ±ÿ≥ÿßŸÑÿ© ÿ£Ÿà ŸÜÿ≥ÿÆ.",
                call_911: "ÿßÿ™ÿµŸÑ 911",
                text_911: "ÿ±ÿ≥ÿßŸÑÿ© 911",
                gps_label: "ÿ•ÿ≠ÿØÿßÿ´Ÿäÿßÿ™ GPS",
                gps_badge: "911 ÿπÿßŸÑŸÖŸä",
                gps_hint: "Ÿáÿ∞ÿß ŸÖÿß Ÿäÿ≠ÿ™ÿßÿ¨Ÿá 911 ÿ£ŸÉÿ´ÿ±",
                intersection_label: "ÿ£ŸÇÿ±ÿ® ÿ™ŸÇÿßÿ∑ÿπ",
                intersection_hint: "ÿßŸÑÿ¥Ÿàÿßÿ±ÿπ ÿ™ÿ≥ÿßÿπÿØ ŸÅŸä ÿßŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸäŸÉ",
                address_label: "ÿπŸÜŸàÿßŸÜ ÿßŸÑÿ¥ÿßÿ±ÿπ",
                maps_label: "ÿÆÿ±ÿßÿ¶ÿ∑ ÿ¨Ÿàÿ¨ŸÑ",
                copy_btn: "ŸÜÿ≥ÿÆ ÿßŸÑŸÉŸÑ",
                copy_success: "ÿ™ŸÖ ÿßŸÑŸÜÿ≥ÿÆ!",
                text_other_btn: "ÿ£ÿ±ÿ≥ŸÑ ŸÑÿ¥ÿÆÿµ ÿ¢ÿÆÿ±",
                refresh_btn: "ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÖŸàŸÇÿπ",
                preview_title: "üì§ ŸÖÿπÿßŸäŸÜÿ© ÿßŸÑÿ±ÿ≥ÿßŸÑÿ© (ÿ®ÿßŸÑÿ•ŸÜÿ¨ŸÑŸäÿ≤Ÿäÿ© ŸÑŸÄ 911):",
                instructions_title: "üìû ÿπŸÜÿØ ÿßŸÑÿßÿ™ÿµÿßŸÑÿå ŸÇŸÑ ÿ®ÿßŸÑÿ•ŸÜÿ¨ŸÑŸäÿ≤Ÿäÿ©:",
                text_911_note: "ŸÜÿßÿ¥ŸÅŸäŸÑ ÿ™ÿØÿπŸÖ ÿßŸÑÿ±ÿ≥ÿßÿ¶ŸÑ ŸÑŸÄ 911. ÿ£ÿ±ÿ≥ŸÑ ÿ±ÿ≥ÿßŸÑÿ© ÿ•ÿ∞ÿß ŸÑŸÖ ÿ™ÿ≥ÿ™ÿ∑ÿπ ÿßŸÑÿ™ÿ≠ÿØÿ´.",
                accuracy_excellent: "ÿßŸÑÿØŸÇÿ©: ŸÖŸÖÿ™ÿßÿ≤ÿ©",
                accuracy_good: "ÿßŸÑÿØŸÇÿ©: ÿ¨ŸäÿØÿ©",
                accuracy_moderate: "ÿßŸÑÿØŸÇÿ©: ŸÖÿ™Ÿàÿ≥ÿ∑ÿ©",
                accuracy_poor: "ÿßŸÑÿØŸÇÿ©: ÿ™ŸÇÿ±Ÿäÿ®Ÿäÿ©"
            },
            ku: {
                back_to_resources: "⁄Ø€ï⁄ïÿßŸÜ€ïŸà€ï ÿ®€Ü ÿ≥€ïÿ±⁄ÜÿßŸà€ï⁄©ÿßŸÜ",
                loading_title: "ÿ¥Ÿà€éŸÜ€ï⁄©€ïÿ™ ÿØ€ïÿØ€Üÿ≤ÿ±€éÿ™€ïŸà€ï",
                loading_desc: "⁄ï€é⁄Ø€ï ÿ®ÿØ€ï ÿ®€ï ÿØ€ïÿ≥ÿ™⁄Ø€ï€åÿ¥ÿ™ŸÜ ÿ®€ï ÿ¥Ÿà€éŸÜ...",
                error_title: "Ÿá€ï⁄µ€ï€å ÿ¥Ÿà€éŸÜ",
                error_generic: "ŸÜ€ïÿ™ŸàÿßŸÜÿ±ÿß ÿ¥Ÿà€éŸÜ€ï⁄©€ïÿ™ ÿ®ÿØ€Üÿ≤ÿ±€éÿ™€ïŸà€ï.",
                error_denied: "⁄ï€ïÿ™⁄©ÿ±ÿß€å€ïŸà€ï. ⁄ï€é⁄Ø€ïŸæ€éÿØÿßŸÜ ⁄ÜÿßŸÑÿß⁄© ÿ®⁄©€ï.",
                error_unavailable: "ÿ¥Ÿà€éŸÜ ÿ®€ïÿ±ÿØ€ïÿ≥ÿ™ ŸÜ€å€å€ï. ÿØŸàŸàÿ®ÿßÿ±€ï Ÿá€ïŸà⁄µ ÿ®ÿØ€ïŸà€ï.",
                error_timeout: "⁄©ÿßÿ™ ÿ™€éŸæ€ï⁄ï€å. ÿØŸàŸàÿ®ÿßÿ±€ï Ÿá€ïŸà⁄µ ÿ®ÿØ€ïŸà€ï.",
                try_again: "ÿØŸàŸàÿ®ÿßÿ±€ï Ÿá€ïŸà⁄µ ÿ®ÿØ€ïŸà€ï",
                embedded_title: "Ÿæ€éŸà€åÿ≥ÿ™€å ÿ®€ï ÿØ€ïÿ≥ÿ™⁄Ø€ï€åÿ¥ÿ™ŸÜ ÿ®€ï ÿ¥Ÿà€éŸÜ",
                embedded_desc: "ÿ®€Ü ÿ≥€ïŸÑÿßŸÖ€ïÿ™€åÿ™ÿå ÿØ€ïÿ≥ÿ™⁄Ø€ï€åÿ¥ÿ™ŸÜ ÿ®€ï ÿ¥Ÿà€éŸÜ Ÿæ€éŸà€åÿ≥ÿ™€å ÿ®€ï ⁄©ÿ±ÿØŸÜ€ïŸà€ï€å ⁄ïÿßÿ≥ÿ™€ïŸàÿÆ€Ü€å ÿ¶€ïŸÖ Ÿæ€ï⁄ï€ï€å€ï Ÿá€ï€å€ï. ÿØŸà⁄ØŸÖ€ï⁄©€ï ÿ®Ÿæ€ïŸÜÿ¨€éŸÜ€ï ÿ®€Ü Ÿà€ïÿ±⁄Øÿ±ÿ™ŸÜ€å ÿ¥Ÿà€éŸÜ€ï⁄©€ïÿ™ ÿ®€Ü 911.",
                open_new_btn: "⁄©ÿ±ÿØŸÜ€ïŸà€ï€å ÿ¶ÿßŸÖÿ±ÿßÿ≤€å 911",
                title: "ÿ¥Ÿà€éŸÜ€å ŸÅÿ±€åÿß⁄©€ïŸàÿ™ŸÜ€å 911",
                subtitle: "ÿ¥Ÿà€éŸÜ€ï⁄©€ïÿ™ ŸáÿßŸàÿ®€ïÿ¥ ÿ®⁄©€ï",
                privacy_notice: "ÿ¥Ÿà€éŸÜ€ï⁄©€ïÿ™ ÿ™ÿß€åÿ®€ïÿ™ ÿØ€ïŸÖ€éŸÜ€éÿ™€ïŸà€ï ŸÑ€ï ÿ¶ÿßŸÖ€éÿ±€ï⁄©€ïÿ™. Ÿá€å⁄Ü ÿ¥ÿ™€é⁄© ŸáÿßŸàÿ®€ïÿ¥ ŸÜÿß⁄©ÿ±€éÿ™ ŸÖ€ï⁄Ø€ïÿ± ÿ™€Ü ÿÆ€Üÿ™ ÿ®€åÿ®ŸÜ€éÿ±€åÿ™ ÿ®€ï Ÿæ€ï€åŸà€ïŸÜÿØ€åÿå ŸÜÿßŸÖ€ïÿå €åÿßŸÜ ŸÑ€ïÿ®€ïÿ±⁄Øÿ±ÿ™ŸÜ€ïŸà€ï.",
                call_911: "Ÿæ€ï€åŸà€ïŸÜÿØ€å 911",
                text_911: "ŸÜÿßŸÖ€ï 911",
                gps_label: "⁄©€Üÿ¶€Üÿ±ÿØ€åŸÜÿßÿ™€å GPS",
                gps_badge: "911 ÿ¨€åŸáÿßŸÜ€å",
                gps_hint: "ÿ¶€ïŸÖ€ï Ÿæ€éŸà€åÿ≥ÿ™ÿ™ÿ±€åŸÜ€ï ÿ®€Ü 911",
                intersection_label: "ŸÜÿ≤€å⁄©ÿ™ÿ±€åŸÜ ÿÆÿß⁄Ü€ï⁄ï€é",
                intersection_hint: "ÿ¥€ïŸÇÿßŸÖ€ï⁄©ÿßŸÜ €åÿßÿ±ŸÖ€ïÿ™€å ÿØ€ïÿØ€ïŸÜ",
                address_label: "ŸÜÿßŸàŸÜ€åÿ¥ÿßŸÜ",
                maps_label: "ŸÜ€ïÿÆÿ¥€ï€å ⁄ØŸàŸà⁄Ø⁄µ",
                copy_btn: "Ÿá€ïŸÖŸàŸà ŸÑ€ïÿ®€ïÿ±⁄Øÿ±ÿ™ŸÜ€ïŸà€ï",
                copy_success: "ŸÑ€ïÿ®€ïÿ±⁄Ø€åÿ±ÿß!",
                text_other_btn: "ŸÜÿßŸÖ€ï ÿ®ŸÜ€éÿ±€ï ÿ®€Ü ⁄©€ïÿ≥€é⁄©€å ÿ™ÿ±",
                refresh_btn: "ŸÜŸà€é⁄©ÿ±ÿØŸÜ€ïŸà€ï",
                preview_title: "üì§ Ÿæ€éÿ¥ÿ®€åŸÜ€åŸÜ€å ŸÜÿßŸÖ€ï (ÿ®€ï ÿ¶€åŸÜ⁄ØŸÑ€åÿ≤€å ÿ®€Ü 911):",
                instructions_title: "üìû ÿ®€ï ÿ¶€åŸÜ⁄ØŸÑ€åÿ≤€å ÿ®⁄µ€é:",
                text_911_note: "ŸÜÿßÿ¥⁄§€åŸÑ ŸÜÿßŸÖ€ï ÿ®€Ü 911 Ÿæÿ¥ÿ™⁄Ø€åÿ±€å ÿØ€ï⁄©ÿßÿ™.",
                accuracy_excellent: "Ÿàÿ±ÿØ€å: ŸÜÿß€åÿßÿ®",
                accuracy_good: "Ÿàÿ±ÿØ€å: ÿ®ÿßÿ¥",
                accuracy_moderate: "Ÿàÿ±ÿØ€å: ŸÖÿßŸÖŸÜÿßŸà€ïŸÜÿØ",
                accuracy_poor: "Ÿàÿ±ÿØ€å: ŸÜÿ≤€å⁄©"
            },
            vi: {
                back_to_resources: "Quay l·∫°i T√†i Nguy√™n",
                loading_title: "ƒêang L·∫•y V·ªã Tr√≠",
                loading_desc: "Vui l√≤ng cho ph√©p truy c·∫≠p v·ªã tr√≠...",
                error_title: "L·ªói V·ªã Tr√≠",
                error_generic: "Kh√¥ng th·ªÉ l·∫•y v·ªã tr√≠.",
                error_denied: "B·ªã t·ª´ ch·ªëi. Vui l√≤ng b·∫≠t quy·ªÅn v·ªã tr√≠.",
                error_unavailable: "V·ªã tr√≠ kh√¥ng kh·∫£ d·ª•ng. Th·ª≠ l·∫°i.",
                error_timeout: "H·∫øt th·ªùi gian. Th·ª≠ l·∫°i.",
                try_again: "Th·ª≠ L·∫°i",
                embedded_title: "C·∫ßn Truy C·∫≠p V·ªã Tr√≠",
                embedded_desc: "V√¨ s·ª± an to√†n c·ªßa b·∫°n, truy c·∫≠p v·ªã tr√≠ y√™u c·∫ßu m·ªü trang n√†y tr·ª±c ti·∫øp. Nh·∫•n n√∫t b√™n d∆∞·ªõi ƒë·ªÉ l·∫•y v·ªã tr√≠ cho 911.",
                open_new_btn: "M·ªü C√¥ng C·ª• 911",
                title: "V·ªã Tr√≠ Kh·∫©n C·∫•p 911",
                subtitle: "Chia s·∫ª v·ªã tr√≠ v·ªõi d·ªãch v·ª• c·∫•p c·ª©u",
                privacy_notice: "V·ªã tr√≠ c·ªßa b·∫°n ƒë∆∞·ª£c gi·ªØ ri√™ng t∆∞ tr√™n thi·∫øt b·ªã. Kh√¥ng c√≥ g√¨ ƒë∆∞·ª£c chia s·∫ª tr·ª´ khi B·∫†N ch·ªçn g·ª≠i qua cu·ªôc g·ªçi, tin nh·∫Øn, ho·∫∑c sao ch√©p.",
                call_911: "G·ªåI 911",
                text_911: "NH·∫ÆN 911",
                gps_label: "T·ªåA ƒê·ªò GPS",
                gps_badge: "911 TO√ÄN C·∫¶U",
                gps_hint: "ƒê√¢y l√† th√¥ng tin 911 c·∫ßn nh·∫•t",
                intersection_label: "GIAO L·ªò G·∫¶N NH·∫§T",
                intersection_hint: "C√°c ƒë∆∞·ªùng giao gi√∫p t√¨m b·∫°n",
                address_label: "ƒê·ªäA CH·ªà",
                maps_label: "GOOGLE MAPS",
                copy_btn: "Sao Ch√©p T·∫•t C·∫£",
                copy_success: "ƒê√£ Sao Ch√©p!",
                text_other_btn: "Nh·∫Øn Cho Ng∆∞·ªùi Kh√°c",
                refresh_btn: "L√†m M·ªõi",
                preview_title: "üì§ Xem tr∆∞·ªõc tin nh·∫Øn (ti·∫øng Anh cho 911):",
                instructions_title: "üìû Khi g·ªçi, n√≥i ti·∫øng Anh:",
                text_911_note: "Nashville h·ªó tr·ª£ nh·∫Øn 911. Nh·∫Øn n·∫øu kh√¥ng th·ªÉ n√≥i.",
                accuracy_excellent: "ƒê·ªô ch√≠nh x√°c: Xu·∫•t s·∫Øc",
                accuracy_good: "ƒê·ªô ch√≠nh x√°c: T·ªët",
                accuracy_moderate: "ƒê·ªô ch√≠nh x√°c: Trung b√¨nh",
                accuracy_poor: "ƒê·ªô ch√≠nh x√°c: G·∫ßn ƒë√∫ng"
            }
        };

        let currentLang = 'en';
        let currentLocation = null;
        let currentAccuracy = null;
        let currentAddress = null;

        // Get language from URL parameter (?es, ?ar, etc.)
        function getLanguageFromURL() {
            // First check the current page's URL
            const search = window.location.search.slice(1).toLowerCase(); // Remove '?' and lowercase
            if (search && translations[search]) {
                return search;
            }
            // If embedded, also check the referrer URL (parent page) for language parameter
            if (document.referrer) {
                try {
                    const referrerUrl = new URL(document.referrer);
                    const referrerLang = referrerUrl.search.slice(1).toLowerCase();
                    if (referrerLang && translations[referrerLang]) {
                        return referrerLang;
                    }
                } catch (e) {
                    // Invalid referrer URL, ignore
                }
            }
            return null;
        }

        // Update URL with current language without adding history entry
        function updateURLWithLanguage(lang) {
            const url = new URL(window.location);
            url.search = (lang === 'en') ? '' : `?${lang}`;
            window.history.replaceState({}, '', url);
        }

        // Update internal navigation links to preserve language
        function updateInternalLinks(lang) {
            document.querySelectorAll('.emergency-link, .back-link').forEach(link => {
                const baseUrl = link.getAttribute('href').split('?')[0];
                link.href = (lang === 'en') ? baseUrl : `${baseUrl}?${lang}`;
            });
        }

        function setLanguage(lang) {
            currentLang = lang;
            const t = translations[lang];

            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (t[key]) el.textContent = t[key];
            });

            document.querySelectorAll('.lang-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.lang === lang);
            });

            document.documentElement.setAttribute('dir', (lang === 'ar' || lang === 'ku') ? 'rtl' : 'ltr');
            document.documentElement.setAttribute('lang', lang);

            localStorage.setItem('nashville-resources-lang', lang);
            updateInternalLinks(lang);
            updateURLWithLanguage(lang);

            if (currentLocation) updateDisplay();
        }

        document.querySelectorAll('.lang-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                trackActivity('language_change', { language: btn.dataset.lang });
                setLanguage(btn.dataset.lang);
            });
        });

        // Check URL parameter first, then localStorage
        const urlLang = getLanguageFromURL();
        const savedLang = localStorage.getItem('nashville-resources-lang');
        if (urlLang) {
            setLanguage(urlLang);
        } else if (savedLang && translations[savedLang]) {
            setLanguage(savedLang);
        }

        // Text size controls
        const textSizes = ['small', 'normal', 'large', 'xlarge'];

        function setTextSize(size) {
            // Remove all size classes
            textSizes.forEach(s => document.documentElement.classList.remove(`text-${s}`));
            // Add the selected size class
            document.documentElement.classList.add(`text-${size}`);
            // Update button states
            document.querySelectorAll('.text-size-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.size === size);
            });
            // Save preference (shared with main page)
            localStorage.setItem('nashville-resources-textsize', size);
        }

        document.querySelectorAll('.text-size-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                trackActivity('text_size_change', { size: btn.dataset.size });
                setTextSize(btn.dataset.size);
            });
        });

        // Load saved text size (shared with main page)
        const savedTextSize = localStorage.getItem('nashville-resources-textsize');
        if (savedTextSize && textSizes.includes(savedTextSize)) {
            setTextSize(savedTextSize);
        }

        function formatCoords(lat, lng) {
            return `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
        }

        function getAccuracyInfo(meters) {
            const t = translations[currentLang];
            if (meters <= 10) return { label: t.accuracy_excellent, class: 'accuracy-excellent' };
            if (meters <= 30) return { label: t.accuracy_good, class: 'accuracy-good' };
            if (meters <= 100) return { label: t.accuracy_moderate, class: 'accuracy-moderate' };
            return { label: t.accuracy_poor, class: 'accuracy-poor' };
        }

        async function reverseGeocode(lat, lng) {
            try {
                const response = await fetch(
                    `https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lng}&format=json&addressdetails=1&zoom=18`,
                    { headers: { 'User-Agent': 'Emergency911Widget/1.0' } }
                );
                const data = await response.json();
                const addr = data.address || {};
                return {
                    street: addr.house_number ? `${addr.house_number} ${addr.road || ''}` : (addr.road || ''),
                    city: addr.city || addr.town || addr.village || '',
                    state: addr.state || '',
                    zip: addr.postcode || ''
                };
            } catch (err) { return null; }
        }

        async function findNearestIntersection(lat, lng) {
            try {
                const query = `[out:json][timeout:10];(way["highway"~"^(primary|secondary|tertiary|residential|unclassified)$"](around:150,${lat},${lng}););out body;`;
                const response = await fetch('https://overpass-api.de/api/interpreter', { method: 'POST', body: query });
                const data = await response.json();
                const roads = data.elements.filter(e => e.type === 'way' && e.tags?.name).map(e => e.tags.name).filter((v, i, a) => a.indexOf(v) === i);
                if (roads.length >= 2) return `${roads[0]} & ${roads[1]}`;
                if (roads.length === 1) return `Near ${roads[0]}`;
                return null;
            } catch (err) { return null; }
        }

        function showLoading() {
            document.getElementById('loadingState').classList.remove('hidden');
            document.getElementById('errorState').classList.add('hidden');
            document.getElementById('mainContent').classList.add('hidden');
        }

        function showError(errorKey) {
            const t = translations[currentLang];
            document.getElementById('loadingState').classList.add('hidden');
            document.getElementById('errorState').classList.remove('hidden');
            document.getElementById('mainContent').classList.add('hidden');
            document.getElementById('errorMessage').textContent = t[errorKey] || t.error_generic;
        }

        function showContent() {
            document.getElementById('loadingState').classList.add('hidden');
            document.getElementById('errorState').classList.add('hidden');
            document.getElementById('mainContent').classList.remove('hidden');
        }

        function updateDisplay() {
            const { lat, lng } = currentLocation;
            const coordsStr = formatCoords(lat, lng);

            document.getElementById('gpsCoords').textContent = coordsStr;

            if (currentAccuracy) {
                const accInfo = getAccuracyInfo(currentAccuracy);
                document.getElementById('accuracyText').textContent = `${accInfo.label} (¬±${Math.round(currentAccuracy)}m)`;
                document.getElementById('accuracyText').className = `accuracy-text ${accInfo.class}`;
            }

            const mapsUrl = `https://maps.google.com/?q=${lat},${lng}`;
            document.getElementById('mapsLink').href = mapsUrl;
            document.getElementById('mapsLink').textContent = mapsUrl;

            document.getElementById('callScript').textContent = `"My GPS coordinates are ${coordsStr}"`;

            updateTextLink();
            updateOutputPreview();
        }

        function updateTextLink() {
            document.getElementById('textBtn').href = `sms:911?body=${encodeURIComponent(buildEmergencyMessage())}`;
        }

        function buildEmergencyMessage() {
            if (!currentLocation) return '';
            const { lat, lng } = currentLocation;
            const coordsStr = formatCoords(lat, lng);

            let msg = `EMERGENCY - MY LOCATION:\n\nGPS: ${coordsStr}\n\n`;

            if (currentAddress?.intersection) msg += `INTERSECTION: ${currentAddress.intersection}\n\n`;

            if (currentAddress?.street) {
                msg += `ADDRESS: ${currentAddress.street}`;
                if (currentAddress.city) msg += `, ${currentAddress.city}`;
                if (currentAddress.state) msg += `, ${currentAddress.state}`;
                if (currentAddress.zip) msg += ` ${currentAddress.zip}`;
                msg += `\n\n`;
            }

            msg += `MAP: https://maps.google.com/?q=${lat},${lng}\n\nAccuracy: ¬±${Math.round(currentAccuracy)}m`;

            return msg;
        }

        function updateOutputPreview() {
            document.getElementById('outputPreview').textContent = buildEmergencyMessage();
        }

        async function copyToClipboard() {
            trackActivity('copy_location', {});
            const t = translations[currentLang];
            try {
                await navigator.clipboard.writeText(buildEmergencyMessage());
                const btn = document.getElementById('copyBtn');
                btn.classList.add('copied');
                btn.innerHTML = `<svg class="icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg><span>${t.copy_success}</span>`;
                setTimeout(() => {
                    btn.classList.remove('copied');
                    btn.innerHTML = `<svg class="icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg><span>${t.copy_btn}</span>`;
                }, 2000);
            } catch (err) {
                // Fallback for older browsers
                const textarea = document.createElement('textarea');
                textarea.value = buildEmergencyMessage();
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);

                const btn = document.getElementById('copyBtn');
                btn.classList.add('copied');
                btn.innerHTML = `<svg class="icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg><span>${t.copy_success}</span>`;
                setTimeout(() => {
                    btn.classList.remove('copied');
                    btn.innerHTML = `<svg class="icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg><span>${t.copy_btn}</span>`;
                }, 2000);
            }
        }

        function textSomeoneElse() {
            trackActivity('text_someone_else', {});
            // Open SMS app without a pre-filled number, letting user enter their own recipient
            const message = buildEmergencyMessage();
            const encodedMessage = encodeURIComponent(message);

            // iOS requires &body= format, Android requires ?body= format
            const isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);
            const separator = isIOS ? '&' : '?';

            window.location.href = `sms:${separator}body=${encodedMessage}`;
        }

        async function getLocation() {
            trackActivity('refresh_location', {});
            showLoading();

            if (!navigator.geolocation) { showError('error_generic'); return; }

            navigator.geolocation.getCurrentPosition(
                async (position) => {
                    const { latitude: lat, longitude: lng, accuracy } = position.coords;

                    currentLocation = { lat, lng };
                    currentAccuracy = accuracy;

                    showContent();
                    updateDisplay();

                    const [addr, intersection] = await Promise.all([
                        reverseGeocode(lat, lng),
                        findNearestIntersection(lat, lng)
                    ]);

                    if (addr) {
                        currentAddress = { ...addr, intersection };

                        if (addr.street) {
                            let fullAddr = addr.street;
                            if (addr.city) fullAddr += `, ${addr.city}`;
                            if (addr.state) fullAddr += `, ${addr.state}`;
                            if (addr.zip) fullAddr += ` ${addr.zip}`;
                            document.getElementById('streetAddress').textContent = fullAddr;
                            document.getElementById('addressCard').style.display = 'block';
                        }

                        if (intersection) {
                            document.getElementById('intersection').textContent = intersection;
                            document.getElementById('intersectionCard').style.display = 'block';
                            document.getElementById('callScript').textContent = `"My GPS coordinates are ${formatCoords(lat, lng)}"\n\n"I'm near ${intersection}"`;
                        }
                    }

                    updateTextLink();
                    updateOutputPreview();
                },
                (error) => {
                    const errorMap = { 1: 'error_denied', 2: 'error_unavailable', 3: 'error_timeout' };
                    showError(errorMap[error.code] || 'error_generic');
                },
                { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 }
            );
        }

        function isEmbedded() {
            try {
                return window.self !== window.top;
            } catch (e) {
                // If we can't access window.top due to cross-origin restrictions, we're embedded
                return true;
            }
        }

        function showEmbedded() {
            document.getElementById('loadingState').classList.add('hidden');
            document.getElementById('errorState').classList.add('hidden');
            document.getElementById('mainContent').classList.add('hidden');
            document.getElementById('embeddedState').classList.remove('hidden');

            // Set the URL for the "Open in new window" button
            document.getElementById('openNewBtn').href = window.location.href;
        }

        window.onload = function() {
            if (isEmbedded()) {
                // When embedded, always prompt to open in new tab for reliable geolocation
                showEmbedded();
            } else {
                getLocation();
            }

            // Track Call 911 button click
            document.querySelector('.btn-call')?.addEventListener('click', () => {
                trackActivity('call_911', {});
            });

            // Track Text 911 button click
            document.getElementById('textBtn')?.addEventListener('click', () => {
                trackActivity('text_911', {});
            });

            // Track Back to Resources link click
            document.querySelector('.back-link')?.addEventListener('click', () => {
                trackActivity('back_to_resources', {});
            });
        };
    </script>
</body>
</html>
